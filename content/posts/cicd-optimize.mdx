---
title: CI/CD æµç¨‹å„ªåŒ–æ¡ˆä¾‹ï¼šç¸®çŸ­ Build æ™‚é–“èˆ‡ Image Pull åŠ é€Ÿ
date: 2025-6-06 08:00:00 +0800
description: æœ¬æ–‡åˆ†äº«å¦‚ä½•å„ªåŒ–å…¬å¸å…§éƒ¨è‡ªå»º runner çš„ CI/CD æµç¨‹ï¼Œå¾ image pull rate limit å•é¡Œåˆ‡å…¥ï¼Œå°‡å¤§å‹å®¹å™¨é¡åƒå¾ GitHub Container Registry è½‰ç§»è‡³ GCP GARï¼ŒæˆåŠŸå°‡æ‹‰å–æ™‚é–“å¾æ•¸ååˆ†é˜ç¸®çŸ­åˆ° 3 åˆ†é˜ï¼Œä¸¦åˆ†æå¾ŒçºŒ build-script cache çš„å¯èƒ½æ€§ã€‚
tags: [CI/CD, DevOps, GCP, ContainerRegistry, PipelineOptimization, Docker]
---

## TL;DR
- CI/CD pipeline å„ªåŒ–æ¡ˆä¾‹ï¼šåŠ é€Ÿ build æµç¨‹  
- é‡å° **image pull** èˆ‡ **build-script** å…©å¤§è€—æ™‚é»é€²è¡Œåˆ†æèˆ‡æ”¹å–„  

---

## èƒŒæ™¯
å…¬å¸å…§éƒ¨ä½¿ç”¨è‡ªå»º CI/CD runnerã€‚  
æŸæœå‹™çš„ pipeline **build éšæ®µéœ€è¶…é 30 åˆ†é˜** æ‰èƒ½å®Œæˆã€‚  

åˆ†æç™¼ç¾ä¸»è¦ç“¶é ¸ä¾†è‡ªï¼š  
1. **image pull**  
2. **build-script**  

![CICD slow 1](../assets/post/cicd/cicd-slow1.png)  
![CICD slow 2](../assets/post/cicd/cicd-slow2.png)  

---

## Pull Image å„ªåŒ–
è©²æœå‹™åŸæœ¬ä½¿ç”¨ GitHub Container Registry (ghcr)ï¼Œå—åˆ° **rate limit é™åˆ¶**ï¼Œå°è‡´æ‹‰å–æ™‚é–“éé•·ã€‚  

ğŸ‘‰ è§£æ³•ï¼š  
- å…ˆå°‡ image æ‰‹å‹•æ‹‰ä¸‹ä¾†ã€‚  
- å†æ¨é€åˆ° **èˆ‡ runner åŒ GCP Project çš„ GAR (Google Artifact Registry)**ã€‚  

åœ¨ push éç¨‹ä¸­ç™¼ç¾ï¼š  
- è¨±å¤š layer é‡è¤‡ã€‚  
- image size å¾ **23GB æ¸›å°‘åˆ°ä¸è¶³ 10GB**ã€‚  

![Repeated layer](../assets/post/cicd/repeat-layer.png)  
![img-gar](../assets/post/cicd/img-gar.png)  

èª¿æ•´å¾Œæˆæœï¼š  
- **image pull åƒ…éœ€ 3 åˆ†é˜**ã€‚  

![cicd img-pull optimize](../assets/post/cicd/cicd%20img-pull%20optimize.png)  

---

## Build-Script å„ªåŒ– (å°šæœªå¯¦æ¸¬)
ç”±æ–¼ä»»å‹™æœ‰èŠ±è²»é™åˆ¶ï¼Œæš«æ™‚ç„¡æ³•æ¸¬è©¦é‡å° `build-script` åŠ å…¥ **cache** çš„åŠ é€Ÿæ–¹æ¡ˆã€‚  

---

## å‚™è¨»ï¼šImage ç¶­è­·å•é¡Œ
ä½¿ç”¨ `docker history` æª¢æŸ¥ï¼Œç™¼ç¾è©² image **ä¸¦éé€é Dockerfile ç®¡ç†**ï¼Œè€Œæ˜¯ç”¨ bash script ç–ŠåŠ ç”Ÿæˆï¼š  

```bash
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
5d588bd86c57   5 weeks ago     bash                                            5.74GB    
<missing>      6 weeks ago     /bin/bash                                       11.3GB    
<missing>      6 weeks ago     /bin/bash                                       1.35kB    
<missing>      7 weeks ago     bash                                            202B      
<missing>      7 weeks ago     bash                                            1.15GB    
<missing>      7 weeks ago     bash                                            135MB     
<missing>      12 months ago   RUN |2 flutter_ver=3.22.2 build_rev=0 /bin/sâ€¦   2.54GB    buildkit.dockerfile.v0
<missing>      12 months ago   ENV FLUTTER_HOME=/usr/local/flutter FLUTTER_â€¦   0B        buildkit.dockerfile.v0
<missing>      12 months ago   ARG build_rev=0                                 0B        buildkit.dockerfile.v0
<missing>      12 months ago   ARG flutter_ver=3.22.2                          0B        buildkit.dockerfile.v0
<missing>      13 months ago   RUN /bin/sh -c yes | sdkmanager     "platforâ€¦   259MB     buildkit.dockerfile.v0
<missing>      13 months ago   ENV ANDROID_BUILD_TOOLS_VERSION=34.0.0          0B        buildkit.dockerfile.v0
<missing>      13 months ago   ENV ANDROID_PLATFORM_VERSION=34                 0B        buildkit.dockerfile.v0
<missing>      13 months ago   RUN /bin/sh -c if [ $(uname -m) == "x86_64" â€¦   0B        buildkit.dockerfile.v0
<missing>      13 months ago   RUN /bin/sh -c set -o xtrace     && cd /opt â€¦   1.36GB    buildkit.dockerfile.v0
<missing>      13 months ago   ENV ANDROID_SDK_TOOLS_VERSION=10406996          0B        buildkit.dockerfile.v0
<missing>      13 months ago   ENV ANDROID_SDK_ROOT=/opt/android-sdk-linux â€¦   0B        buildkit.dockerfile.v0
<missing>      13 months ago   ENV ANDROID_HOME=/opt/android-sdk-linux LANGâ€¦   0B        buildkit.dockerfile.v0
<missing>      13 months ago   USER root                                       0B        buildkit.dockerfile.v0
<missing>      13 months ago   LABEL org.opencontainers.image.source=https:â€¦   0B        buildkit.dockerfile.v0
<missing>      13 months ago   /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B        
<missing>      13 months ago   /bin/sh -c #(nop) ADD file:ac9d5a9d5b9b1217aâ€¦   76.2MB    
<missing>      13 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.â€¦   0B        
<missing>      13 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.â€¦   0B        
<missing>      13 months ago   /bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH     0B        
<missing>      13 months ago   /bin/sh -c #(nop)  ARG RELEASE                  0B        
```

ğŸ‘‰ å•é¡Œï¼š
- ç„¡ Dockerfile ç‰ˆæœ¬æ§ç®¡ã€‚
- å¾ŒçºŒç¶­è­·èˆ‡å„ªåŒ–å›°é›£ã€‚

---

ğŸ“Œ é—œéµå­—ï¼šCI/CD Pipelineã€DevOpsã€Container Registryã€GARã€Docker Image å„ªåŒ–ã€Build Cacheã€Pipeline åŠ é€Ÿ
