---
title: ç¶²è·¯ç·šè·¯æ’æŸ¥æ¡ˆä¾‹ï¼šç•¶ä½ çš„ CDN å…¶å¯¦ä¸æ˜¯ CDN
description: æœ¬æ–‡åˆ†äº«ä¸€æ¬¡ GCP ç’°å¢ƒä¸‹çš„ç¶²è·¯ç·šè·¯æ’æŸ¥æ¡ˆä¾‹ï¼Œå¾ nslookupã€Global LoadBalancer èˆ‡ NEG æ¶æ§‹åˆ†æï¼Œç™¼ç¾æ‰€è¬‚çš„ CDN domain å¯¦éš›ä»æ‰“åˆ° Kubernetes nginx proxyï¼Œæœ€çµ‚å®šä½åˆ° node è³‡æºç«¶çˆ­å•é¡Œä¸¦æå‡ºè§£æ³•ã€‚
date: 2025-5-20 08:00:00 +0800
tags: [GCP, CDN, Troubleshooting, Kubernetes, Nginx, LoadBalancer, NEG, DevOps, ç¶²è·¯æ’æŸ¥]
---

## TL;DR
- å…§éƒ¨ç·šè·¯è¿½æŸ¥æ¡ˆä¾‹  
- å•é¡Œæ ¹å› ï¼šnode è³‡æºç«¶çˆ­å°è‡´ latencyï¼Œclient fallback ç›´æ¥æ‰“åˆ° server  

## èƒŒæ™¯
å…¬å¸å…§éƒ¨ RD ç‚ºäº†é™ä½å¾Œç«¯è² è¼‰ï¼Œåœ¨å‰ç«¯æ›äº† **CDN**ã€‚  
ä½†è¿‘ä¸€é€±ä»ç™¼ç¾ **client ç›´æ¥é€£ server** çš„ logï¼Œå•é¡Œä¾†æºæœ‰å…©ç¨®å¯èƒ½ï¼š  
1. **CDN æ›æ‰**  
2. **client timeout (2s)**ï¼Œç›´æ¥ fallback é€£ server  

## å•é¡Œè¿½æŸ¥æµç¨‹

### 1. ç¢ºèªç¶²åŸŸè§£æ
å…ˆé€é `nslookup` æª¢æŸ¥æœå‹™ domainï¼š  
- domain å°æ‡‰åˆ° `34.x.x.x`ï¼Œå±¬æ–¼ **GCP IP ç¯„åœ**ã€‚  
- ç¢ºèª IP æ‰€å±¬æœå‹™ç‚º **Global LoadBalancer**ï¼Œå…¶å¾Œç«¯ (backend) ä½¿ç”¨äº† **NEG (Network Endpoint Group)** æ¶æ§‹ã€‚  

```mermaid
flowchart LR
GLB[Global LoadBalancer]
NEG[NEG Backend Service]
APPs[micro-service]
GLB --> NEG --> APPs
```

é€²ä¸€æ­¥æª¢æŸ¥æ‰ç™¼ç¾ï¼Œæ‰€è¬‚çš„ **cdn domain** èƒŒå¾Œå¯¦éš›ä¸Šï¼š  
- è«‹æ±‚ä»æ‰“é€² **Kubernetes cluster**ã€‚  
- ç¶“ç”± **nginx proxy** å†åˆ°æŒ‡å®šè³‡æºå€‰åº«ã€‚  

### 2. ç¢ºèª nginx proxy ç‹€æ…‹
æ¯”å° RD æå‡ºçš„ç•°å¸¸æ™‚é–“é»ï¼š  
- `5/14 14:10`  
- `5/17 06:31`  
- `5/19 08:38`  

![nginx-proxy log](../assets/post/network-tracing/nginx-proxy%20log.png)  

- ä¸¦ä¸æ˜¯æ‰€æœ‰æ™‚é–“é» log éƒ½å¤§é‡ç•°å¸¸ã€‚  

### 3. è§€å¯Ÿ metrics
æª¢æŸ¥ CPU ä½¿ç”¨ç‹€æ³ï¼š  

![nginx-proxy metrics](../assets/post/network-tracing/nginx-proxy%20metrics.png)  

- æœå‹™æœ¬èº«ä¸¦ç„¡ä¸­æ–·ã€‚  
- ä½†åœ¨éƒ¨åˆ†æ™‚é–“é»ç¢ºå¯¦æœ‰ latency spikeã€‚  

### 4. æª¢æŸ¥ node è³‡æº
å›é ­æª¢æŸ¥è©²æœå‹™æ‰€åœ¨ nodeï¼š  

![nginx-proxy node](../assets/post/network-tracing/nginx-proxy%20node.png)  

- node è³‡æºè¼ƒç‚ºåƒç·Šã€‚  

ä¸¦æª¢æŸ¥è©²æœå‹™è³‡æºé…ç½®ï¼š  

![nginx-proxy resources](../assets/post/network-tracing/nginx-proxy%20resources.png)  

- **CPU æœ‰è¨­ requestï¼Œå»æ²’è¨­ limit**ã€‚  

ğŸ‘‰ **æ¨æ¸¬ root cause**ï¼š  
node è³‡æºåƒç·Š â†’ æœå‹™ç«¶çˆ­ â†’ response latency â†’ client timeout â†’ fallback ç›´é€£ serverã€‚  

---

## è§£æ±ºæ–¹æ¡ˆ
- ç‚º **nginx proxy** è£œä¸Šè³‡æº limitï¼Œé¿å…èˆ‡å…¶ä»– pod æ¶è³‡æºã€‚  
- èª¿æ•´ node è³‡æºé…ç½®ï¼ŒæŒçºŒè§€å¯Ÿæ˜¯å¦æ”¹å–„ã€‚  

---

ğŸ“Œ **é—œéµå­—**ï¼šGCPã€CDNã€Global LoadBalancerã€NEGã€Kubernetesã€Nginx Proxyã€Troubleshootingã€è³‡æºç«¶çˆ­ã€Latencyã€DevOps ç¶²è·¯æ’æŸ¥
