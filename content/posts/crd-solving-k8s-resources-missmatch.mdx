---
title: ç”¨ CRD è§£æ±º GKE è³‡æºä¸åŒæ­¥çš„å•é¡Œ
description: åœ¨ GKE ç’°å¢ƒä¸­ï¼ŒCI/CD pipeline ä½¿ç”¨ kubectl set image å®¹æ˜“é€ æˆè³‡æºèˆ‡ Helm Release ä¸åŒæ­¥ã€‚æœ¬æ–‡æ¯”è¼ƒç´”è…³æœ¬ã€--reuse-valueã€CRD ä¸‰ç¨®è§£æ³•ï¼Œä¸¦æä¾›å®Œæ•´ CRD + CR YAML ç¯„ä¾‹ï¼Œå”åŠ©è§£æ±ºè³‡æºæ¼‚ç§»å•é¡Œã€‚
date: 2025-5-20 08:00:00 +0800
tags: [GCP, CRD, K8s, GKE, Helm, CI/CD, Kubernetes, DevOps]
---
---


# TL;DR
- ç”¨ CRD è§£æ±º CI/CD pipeline å¯èƒ½å°è‡´çš„è³‡æºä¸åŒ¹é…å•é¡Œ

## èƒŒæ™¯
æœå‹™çš„éƒ¨ç½²æ‹†æˆ `project CI/CD` èˆ‡ `helmfile`
è€Œ `project CI/CD` éƒ¨ç½²æ˜¯é€é `kubectl set image` çš„æ–¹å¼æ›´æ–° container image
è€Œç•¶ `project` çš„ GAR è‹¥æœ‰æ›´æ–°ï¼Œæœƒå› ç‚º `set image` æ˜¯ç¹é `helm release` ç›´æ¥é‡å° `K8s component` åšèª¿æ•´ï¼Œå°è‡´ `helm diff` ç„¡æ³•åŠæ™‚å¯Ÿè¦ºå·®ç•°

### ä¸‰å€‹æ–¹æ¡ˆ
- ç”¨ç´”è…³æœ¬
- ç”¨ `helm --reuse-value`
- å¯« `CRDs` é…åˆ `shell script`

#### ç´”è…³æœ¬
ç¾æœ‰æœå‹™çš„éƒ¨ç½²å¤šæ¨£æ€§
- å¯èƒ½ä¸€å€‹ helm release ç”¢ç”ŸåŒ…å« 2 å€‹ä»¥ä¸Šçš„ `Deployment` çš„æœå‹™
- å¯èƒ½ä¸€å€‹ `Deployment` åŒæ™‚åŒ…å«å¤šå€‹ container
- éƒ¨ç½²é¡å‹åŒ…å« `Deployment`, `Statefulset`, `Daemonset`

#### ç”¨ `--reuse-value`
- å°ç¾æœ‰æœå‹™éœ€è¦çµ±ä¸€ `helm chart` ç‰ˆæœ¬ï¼Œä¸¦æ‰“åŒ…æˆ oci
- åœ¨ `project CI/CD` åˆ©ç”¨ `--reuse-value` åŒæ™‚æ›¿æ› `GAR` åƒæ•¸ï¼Œè®“ `helm release` çš„è³‡æºé”åˆ°åŒæ­¥æ›´æ–°

#### ç”¨ `CRD` é…åˆ `shell script`
å¯«ä¸€å€‹ `CRD` ç´€éŒ„æœå‹™ `release` ç›¸é—œ `image` è³‡è¨Šï¼Œä¸¦é€é `shell script` é‡å°æŒ‡å®šè³‡æºåšåŒ¹é…æ¯”å°

- åœ¨å…¨ç’°å¢ƒéƒ¨ç½² `CRDs`
- åœ¨éœ€è¦ç‰ˆæ§çš„æœå‹™é¡å¤–åŠ ä¸Š `CR`
- `Project CI/CD` ç”¨ `kubectl patch` çš„æ–¹å¼ï¼Œå°æœå‹™ `CR` åšè³‡æºèª¿æ•´
- `Helm CI/CD` å…§åˆ©ç”¨ `shell script` é‡å° `CR` åšè³‡æºæ¯”å°
---
ğŸ‘‰  ç´”è…³æœ¬
è¦åœ¨ä¸€å€‹è…³æœ¬åŒæ™‚ç¬¦åˆä¸Šè¿°æ¢ä»¶çš„ä¾¿æ˜¯ï¼Œå…¶é‚è¼¯æœƒéæ–¼è¤‡é›œï¼Œå°å¾ŒçºŒç¶­è­·å¯èƒ½æœƒæœ‰ä¸€å®šè² æ“”
ğŸ‘‰ ç”¨ `--reuse-value`
ç›®å‰ç¾è¡Œçš„æœå‹™ `helm Chart` å¤šæ•¸é‚„æ˜¯åœ¨ local ä¸”æœ‰è¤‡æ•¸å€‹ç‰ˆæœ¬ï¼Œè‹¥è¦ä½¿ç”¨ `--reuse-value` å‰‡éœ€è¦çµ±ä¸€ç‰ˆæœ¬å¾Œæ‰“åŒ…æˆ oci è®“ `project CI/CD` ä½¿ç”¨ï¼Œç‰ˆæœ¬çµ±ä¸€çš„ effort æœƒæœ‰ä¸€å®šè² æ“”
ğŸ‘‰ ç”¨ `CRD` é…åˆ `shell script`
éœ€è¦å¤šäº†è§£ CRD ä»¥åŠ CR çš„ä½¿ç”¨
ä½† `Shell script` çš„é‚è¼¯ç›¸å°å–®ç´”
ä¹Ÿä¸éœ€å¤ªå¤šç•°å‹•

CRD
```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sreimageverifier.pd.sre  # ç”¨æ–¼ kubectl get crd æ™‚æŸ¥è©¢ç”¨çš„å‘½å
spec:
  group: pd.sre
  names:
    kind: SREImageVerifier       # define yaml æ™‚å€™çš„ kind ä½¿ç”¨
    plural: sreimageverifier     # ç”¨æ–¼ kubectl get æ™‚å€™çš„è³‡æºå‘½å
    singular: sreimageverifier
    listKind: SREImageVerifierList
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.imageRegistry
      name: image registry
      type: string
    - jsonPath: .spec.imageTag
      name: image tag
      type: string
    name: v1beta1
    schema:
      openAPIV3Schema:
        description: SRE image tag management
        type: object
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: SREImageVerifierSpec defines the desired state of SREImageVerifier
            type: object
            properties:
              imageRegistry:
                description: Service's current image registry.
                type: string
              imageTag:
                description: Service's current image tag.
                type: string
    served: true      # è©² CR æ˜¯å¦ä»æä¾›æœå‹™
    storage: true     # è©² CR æ˜¯å¦ç‚º etcd ä¸­å„²å­˜ä½¿ç”¨çš„ main version
    subresources:
      status: {}
```

CR
```yaml
apiVersion: pd.sre/v1beta1
kind: SREImageVerifier
metadata:
  name: {{ .Values.app.name }}-imageverifier
spec:
  imageRegistry: {{ .Values.image.repository }}
  imageTag: {{ .Values.image.tag }}
```
