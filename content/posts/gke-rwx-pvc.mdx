---
title: åœ¨ GKE å»ºç«‹æ”¯æ´ ReadWriteMany (RWX) çš„ PVC
description: å®Œæ•´æ•™å­¸ï¼šåœ¨ Google Kubernetes Engine (GKE) ä¸­å»ºç«‹æ”¯æ´ ReadWriteMany å­˜å–æ¨¡å¼çš„ PersistentVolumeClaimï¼ŒåŒ…å« GCP Filestoreã€å¤–éƒ¨ NFS Server å’Œ GCS CSI Driver ä¸‰ç¨®å¯¦ä½œæ–¹å¼ï¼Œè§£æ±ºå¤š Pod åŒæ™‚æ›è¼‰å…±äº«å„²å­˜çš„éœ€æ±‚
---

## TL;DR
ç•¶ Pod éœ€è¦åŒæ™‚æ›è¼‰åŒä¸€å€‹ PVCï¼Œä¸¦ä¸”å¤šå€‹ replicas éƒ½èƒ½åŒæ™‚è®€å¯«è³‡æ–™æ™‚ï¼Œå°±éœ€è¦ä½¿ç”¨ ReadWriteMany (RWX) çš„ PVCã€‚æœ¬æ–‡å°‡ä»‹ç´¹ä¸‰ç¨®å¸¸è¦‹æ–¹å¼ï¼š

1. åˆ©ç”¨ GCP Filestore
2. ä½¿ç”¨ å¤–éƒ¨ NFS Server
3. é€é GCS CSI Driver

## èƒŒæ™¯
åœ¨ Kubernetes ä¸­ï¼Œå¦‚æœä¸€å€‹æœå‹™ä½¿ç”¨ PVC å„²å­˜è³‡æ–™ï¼Œä¸¦ä¸”éœ€è¦é«˜å¯ç”¨æ€§ (HA)ï¼Œé‚£éº¼å¤šå€‹ replicas çš„ Pod å°±å¿…é ˆåŒæ™‚æ›è¼‰ä¸¦å­˜å–ç›¸åŒçš„è³‡æ–™ã€‚é€™æ™‚å€™å°±éœ€è¦ RWX å‹åˆ¥çš„ PVCã€‚

---

### æ–¹æ³•ä¸€ï¼šåˆ©ç”¨ GCP Filestore å»ºç«‹ RWX PVC
å•Ÿç”¨ Filestore CSI Driver
åœ¨ GKE å¢é›†è¨­å®šä¸­ï¼Œé–‹å•Ÿ `gcp_filestore_csi_driver_config`:
```
~ addons_config {
    ~ gcp_filestore_csi_driver_config {
        ~ enabled = false -> true
    }
}
```
å»ºç«‹ StorageClass
å»ºç«‹ä¸€å€‹ä½¿ç”¨ Filestore çš„ StorageClass:
```
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {{ .Values.storageClassName }}
provisioner: filestore.csi.storage.gke.io
parameters:
  tier: BASIC_HDD                          # å¯é¸ BASIC_HDD æˆ– BASIC_SSD
  network: {{ .Values.your_pvc_network }}
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer    # ä¹Ÿå¯è¨­ç‚º Immediate

```
å¯ä»¥é€éæŒ‡ä»¤ `kubectl get sc` æª¢æŸ¥ï¼š
#![fs_sc](../assets/post/gke-rwx-pvc/fs_sc.png)
æˆåŠŸå¾Œï¼Œå»ºç«‹ PVC ä¸¦æ›è¼‰åˆ° Podï¼Œå³æœƒè‡ªå‹•å»ºç«‹å°æ‡‰çš„ Filestore instance
#![fs](../assets/post/gke-rwx-pvc/fs.png)
#![fs_pvc](../assets/post/gke-rwx-pvc/fs_pvc.png)

ä¸¦æ”¯æ´å¤šå€‹ Pod åŒæ™‚æ›è¼‰ RWX PVCã€‚
#![fs_pvc_mount](../assets/post/gke-rwx-pvc/fs_pvc_mount.png)
#![fs_pvc_mount_pods](../assets/post/gke-rwx-pvc/fs_pvc_mount_pods.png)

> âš ï¸ æ³¨æ„ï¼šå¿…é ˆä½¿ç”¨ GKE 1.33 ä»¥ä¸Šç‰ˆæœ¬ï¼Œæ‰èƒ½è®“ Filestore çš„æœ€å°å®¹é‡å¾ 1TB é™åˆ° 100GiBã€‚
> ğŸ‘‰ [å®˜æ–¹æ–‡ä»¶åƒè€ƒ](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/filestore-csi-driver?hl=zh-tw)


### æ–¹æ³•äºŒï¼šé€éå¤–éƒ¨ NFS Server

å¦ä¸€å€‹å¸¸è¦‹æ–¹å¼æ˜¯ä½¿ç”¨ NFS Serverï¼Œæ­é… CSI Driver ä¾†å»ºç«‹ PVCã€‚
é‹ä½œæµç¨‹å¦‚ä¸‹åœ–ï¼š

![nfs_provisioner](../assets/post/gke-rwx-pvc/nfs_provisioner.png)

ğŸ‘‰ è©³ç´°æ­¥é©Ÿå¯åƒè€ƒ [å°ä¿¡è±¬çš„åŸå§‹éƒ¨è½](https://godleon.github.io/blog/Kubernetes/k8s-Config-StorageClass-with-NFS/)

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ GCS CSI Driver æ›è¼‰ GCS

é™¤äº† Filestore èˆ‡ NFSï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Google Cloud Storage (GCS) æ­é… CSI Driver æä¾› RWX PVCã€‚

æ­¥é©Ÿï¼š

1. å®‰è£ gcs-csi-driver
2. å»ºç«‹ PV & PVCï¼Œæ›è¼‰è‡³ GCS
3. é€é Workload Identity (WI) æˆæ¬Š GCS æ¬Šé™

ç¯„ä¾‹ï¼šå»ºç«‹ PV & PVC
```yaml
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gcs-fuse-csi-pv
spec:
  accessModes:
  - ReadWriteMany
  capacity:
    storage: 1Gi
  storageClassName: example-storage-class  
  mountOptions:
    - implicit-dirs
  csi:
    driver: gcsfuse.csi.storage.gke.io
    volumeHandle: {{ .Values.bucketname }}
  claimRef:
    name: gcs-fuse-csi-static-pvc
    namespace: {{ .Release.Namespace }}
---

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gcs-fuse-csi-static-pvc
  namespace: {{ .Release.Namespace }}
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: example-storage-class
```

å»ºç«‹ ServiceAccount ä¸¦ç¶å®š Workload Identity
```yaml
# serviceAccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    iam.gke.io/gcp-service-account: {{ .Values.WI_GOOGLE_SERVICE_ACCOUNT }}
  name: gcs-fuse
  namespace: {{ .Release.Namespace }}

```

å»ºç«‹ Deployment ä¸¦æ›è¼‰ PVC
```yaml
# Deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gcs-fuse-csi-example
  namespace: {{ .Release.Namespace }}
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gcs-fuse-csi-example
  template:
    metadata:
      labels:
        app: gcs-fuse-csi-example
      annotations:
        gke-gcsfuse/volumes: "true"                 # é€é gcs-fuse sidecar äº’å‹•
        gke-gcsfuse/cpu-request: "20m"              # èª¿æ•´ sidecar è³‡æº
        gke-gcsfuse/memory-request: 128Mi           # èª¿æ•´ sidecar è³‡æº
        gke-gcsfuse/ephemeral-storage-limit: 1Gi    # èª¿æ•´ sidecar è³‡æº
    spec:
      containers:
      - image: busybox
        name: busybox
        command: ["sleep"]
        args: ["infinity"]
        volumeMounts:
        - name: gcs-fuse-csi-static
          mountPath: /data
      serviceAccountName: gcs-fuse
      volumes:
      - name: gcs-fuse-csi-static
        persistentVolumeClaim:
          claimName: gcs-fuse-csi-static-pvc

```
å®Œæˆå¾Œï¼Œå³å¯è®“å¤šå€‹ Pod åŒæ™‚æ›è¼‰ GCS PVï¼Œä¸¦ä»¥ RWX æ¨¡å¼å­˜å–è³‡æ–™ã€‚
reference:
- [ç‚º GKE è¨­å®š Cloud Storage FUSE CSI é©…å‹•ç¨‹å¼ Sidecar å®¹å™¨](https://cloud.google.com/kubernetes-engine/docs/how-to/cloud-storage-fuse-csi-driver-sidecar?hl=zh-tw)
