---
title: Kubernetes Topology Aware Routing å¯¦ä½œèˆ‡æµé‡åˆ†é…ç ”ç©¶
description: åœ¨ GKE å¤šå€ (multi-zone) æ¶æ§‹ä¸‹ï¼Œå•Ÿç”¨ Kubernetes Topology Aware Routing (TAR) ä»¥é™ä½è·¨å€ç¶²è·¯å‚³è¼¸è²»ç”¨ã€‚åŒ…å« TAR è¨­ç½®ã€æ¸¬è©¦é…ç½®ã€EndpointSlice åˆ†é…è¦å‰‡è§€å¯Ÿã€å€åŸŸé–“æµé‡å¯¦æ¸¬èˆ‡ç•°å¸¸è¡Œç‚ºè¨˜éŒ„ã€‚
date: 2025-06-23 08:00:00 +0800
tags: [K8s, TAR, TopologyAwareRouting, GKE, MultiZone, EndpointSlice, CostOptimization, Service, Networking]
---

## TL;DR
Topology Aware Routing (TAR) çš„è¨­ç½®èˆ‡**å¯¦æ¸¬æµé‡åˆ†é…**è¡Œç‚ºè§€å¯Ÿï¼š  
- ç›®çš„ï¼šä¸Šå¤šå€å¾Œå¸Œæœ›é™ä½è·¨å€å‚³è¼¸æˆæœ¬  
- ä½œæ³•ï¼šåœ¨ `Service` åŠ ä¸Š `service.kubernetes.io/topology-mode: "Auto"`  
- å¯¦æ¸¬ï¼šEndpointSlice æœƒä¾è³‡æºæ¯”ä¾‹åˆ†é… zone é…é¡ï¼Œä½† **Pod æ•¸é‡ä¸è¶³æ™‚ TAR æœƒ `Disabled`**ï¼Œæµé‡å›é€€ç‚º `round-robin`

---

## èƒŒæ™¯
å…¬å¸æœå‹™å¾å–® zone å‡ç´šç‚º **multi-zone** å¾Œï¼Œ**è·¨ zone å‚³è¼¸è²»ç”¨æš´å¢**ã€‚æœŸæœ›é€é **Topology Aware Routing (TAR)** åœ¨æ”¯æ´å¤šå€çš„åŒæ™‚ï¼Œ**é™ä½è·¨å€å‚³è¼¸**ã€‚

---

## è¨­ç½® TAR
åœ¨å°æ‡‰æœå‹™çš„ `Service` æ¨™è¨»ï¼š

```yaml
annotations:
  service.kubernetes.io/topology-mode: "Auto"
```
> ç›®çš„ï¼šè®“ kube-proxy / EndpointSlice ä¾æ‹“æ¨¸ã€Œåå¥½è¿‘ç«¯ã€è·¯å¾‘ï¼Œç›¡é‡å°‡æµé‡ç•™åœ¨ç™¼èµ·è«‹æ±‚çš„åŒä¸€å€‹ zoneã€‚

### æ¸¬è©¦è¨­å®šï¼ˆDeployment / Service / ConfigMapï¼‰
> ä½¿ç”¨ `topologySpreadConstraints` è®“ Pod ç›¡é‡å¹³å‡è½åœ¨å„ zoneï¼Œä»¥ä¾¿è§€å¯Ÿ TAR çš„åˆ†é…ã€‚
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-a
  namespace: matt
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-a
  template:
    metadata:
      labels:
        app: nginx-a
    spec:
      # ä½¿ç”¨ topologySpreadConstraints å¼·åˆ¶å¹³å‡åˆ†ä½ˆ
      topologySpreadConstraints:
        - maxSkew: 1  # æœ€å¤šå…è¨±ç›¸å·® 1 å€‹ Pod
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: nginx-a
      # ç§»é™¤åŸæœ¬çš„ podAntiAffinityï¼Œå› ç‚º topologySpreadConstraints å·²ç¶“è™•ç†åˆ†ä½ˆ
      containers:
        - name: nginx
          image: nginx:latest
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
      volumes:
        - name: nginx-conf
          configMap:
            name: nginx-conf
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-a
  namespace: matt
  annotations:
    service.kubernetes.io/topology-mode: "Auto"
spec:
  selector:
    app: nginx-a
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
  namespace: matt
data:
  default.conf: |
    server {
      listen 80;
      location / {
        return 200 "$hostname\n";
      }
    }
```

### å¯¦æ¸¬è§€å¯Ÿï¼šTAR Disabled èˆ‡å•Ÿç”¨æ¢ä»¶

- åœ¨åƒ… 2 å€‹ nginx Podçš„æƒ…å¢ƒä¸‹ï¼ŒTAR å¯æ­£å¸¸é‹ä½œ
- åœ¨æ¸¬è©¦ç’°å¢ƒå…§ï¼ŒTAR é¡¯ç¤º `Disabled` ä¸”ä»ç‚º `round-robin` çš„åˆ†é…æ©Ÿåˆ¶ï¼Œå¾… Pod æ•¸é‡å……è¶³å¾Œæ‰æœƒæ­£å¸¸å•Ÿç”¨

![TAR-disabled](../assets/post/tar/TAR-disabled.png)

#### TAR é‹ä½œæ©Ÿåˆ¶

1. æœå‹™ `svc` è¨­ç½® `annotation` â€“> å½±éŸ¿ `Endpoint-Slice` åˆ†é…æ©Ÿåˆ¶
![endpointslice](../assets/post/tar/endpointslice.png)
2. `Endpoint-Slice` åˆ†é…è¦å‰‡å‚¾å‘ã€Œä¾è³‡æºæ¯”ä¾‹ã€
ä»¥ç¯€é» CPU è³‡æºè¿‘ä¼¼è©•ä¼° zone æ¬Šé‡ï¼ˆç¤ºæ„ï¼‰ï¼š
```js
const nodes = [
    // asia-east1-a
    { zone: 'asia-east1-a', name: 'gke-matt-test-3b627bce-daoo', cpu: 4 },
    { zone: 'asia-east1-a', name: 'gke-pool-A-548e8958-2nxn', cpu: 8 },
    
    // asia-east1-b (10å€‹ç¯€é»)
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-1fv1', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-8bjj', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-crk9', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-ft1u', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-j7jg', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-lvc8', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-px2g', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-A-7ae1a02a-z5z4', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-B-bfdf247d-9f1e', cpu: 8 },
    { zone: 'asia-east1-b', name: 'gke-pool-B-bfdf247d-xg6b', cpu: 8 },
    
    // asia-east1-c
    { zone: 'asia-east1-c', name: 'gke-matt-test-e8520bea-zpl4', cpu: 4 }
  ];
```
æ›ç®—ï¼ˆç¤ºæ„ï¼‰ï¼š
```
asia-east1-a: 12 cores Ã· 96 total cores = 12.5%
asia-east1-b: 80 cores Ã· 96 total cores = 83.3% 
asia-east1-c: 4 cores Ã· 96 total cores = 4.2%
```
ç‚ºç¢ºä¿æ¯å€‹ zone è‡³å°‘æœ‰ä¸€å€‹å¯¦ä¾‹ï¼ˆé¿å…æ¥µç«¯ 0 é…é¡ï¼‰ï¼Œå¯¦éš›åˆ†é…è¿‘ä¼¼ï¼š
| zone-a | zone-b | zone-c |
| ------ | ------ | ------ |
| 1      | 7      | 1      |

#### æµé‡æ¸¬è©¦
å¾ `zone-a` ç”± `nginx-a` ç™¼èµ· requestï¼š
æµé‡å¹¾ä¹éƒ½ç”±åŒ zone çš„å–®ä¸€ `nginx-b` æ‰¿æ“”

![zone-a,nginx-a](../assets/post/tar/zone-a,nginx-a.png)
![zone-a,nginx-b](../assets/post/tar/zone-a,nginx-b.png)

å¾ zone-b ç”± nginx-a ç™¼èµ· requestï¼š

![zone-b,nginx-a](../assets/post/tar/zone-b,nginx-a.png)
![zone-b,nginx-b](../assets/post/tar/zone-b,nginx-b.png)

å›æŸ¥ `EndpointSlice` åˆ†é…å¾Œï¼Œå°è² è²¬ 7 å€‹ `zone-b` çš„ `nginx-b` ä»¥ `Round-Robin` çš„æ©Ÿåˆ¶é€²è¡Œè¼ªè©¢

### çµè«–

1. è®“æœå‹™å‡å‹»åˆ†å¸ƒåœ¨ 3 å€‹ zone ä¸Šï¼Œæ‰èƒ½è®“ TAR çš„æ©Ÿåˆ¶æœ€ä½³åŒ–
2. å¦‚æœ request çš„ä¾†æºé›†ä¸­åœ¨åŒä¸€å€‹ zone
é‚£é‚„æ˜¯æœƒæœ‰ `æµé‡å‚¾æ–œ` çš„æƒ…æ³

---

ğŸ“Œ **é—œéµå­—**ï¼šKubernetesã€Topology Aware Routingã€TARã€GKEã€Multi-Zoneã€è·¨å€æµé‡è²»ç”¨ã€EndpointSliceã€Service Routingã€K8s Networkingã€æµé‡åˆ†é…æ©Ÿåˆ¶ã€Zone è² è¼‰å¹³è¡¡ã€æˆæœ¬å„ªåŒ–
