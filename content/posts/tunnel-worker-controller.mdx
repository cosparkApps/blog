---
title: ç”¨ Cloudflare Tunnel ç‚º GKE ä¸Šçš„ Grafana å»ºç«‹ã€Œè‡¨æ™‚ä¸”å®‰å…¨ã€çš„å¤–éƒ¨é€šé“
description: åœ¨ä¸é•·æœŸæš´éœ² Grafana çš„å‰æä¸‹ï¼Œé€éäº‹ä»¶é©…å‹•çš„ tunnel-worker-controller å‹•æ…‹å»ºç«‹ Cloudflare Tunnelã€‚å…§å«æµç¨‹åœ–ã€Node.js èˆ‡ Kubernetes API å»º Jobã€cloudflared Dockerfileã€å›å‚³è‡¨æ™‚ URL çš„å¯¦ä½œç´°ç¯€èˆ‡å¯¦éš› logsã€‚
date: 2025-06-15 08:00:00 +0800
tags: [Cloudflare, CloudflareTunnel, Security, ZeroTrust, Kubernetes, GKE, Grafana, Observability, K8s, Node.js]
---

## TL;DR
è—‰ç”± `cloudflare-tunnel` åœ¨ `Kubernetes(GKE)` å…§ç‚º `Grafana` æ­å»º**è‡¨æ™‚çš„å®‰å…¨é€šé“**ï¼Œé¿å…é•·æœŸå°å¤–æš´éœ²ï¼ŒåŒæ™‚ä¿æœ‰è‡¨æ™‚è§€æ¸¬ç¶­é‹éœ€æ±‚ã€‚

## èƒŒæ™¯
æˆ‘åœ¨ GKE ä¸Šéƒ¨ç½²äº† `kube-prometheus-stack` åšæœå‹™ `metrics` ç›£æ§ï¼Œä½†ä¸æƒ³è®“ã€ŒGrafana é•·æœŸæš´éœ²ã€æˆç‚ºé¢¨éšªã€‚å› æ­¤è¦åŠƒä»¥**äº‹ä»¶é©…å‹•**çš„æ–¹å¼ï¼Œå‹•æ…‹å»ºç«‹ `Cloudflare Tunnel` â€”â€” ä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ `tunnel-worker-controller`ã€‚

- **ç›®æ¨™**ï¼šæŒ‰éœ€ç”¢ç”Ÿè‡¨æ™‚ã€å¯æ§å­˜å–çš„ Grafana å¤–éƒ¨ URL  
- **åšæ³•**ï¼šç”±æ§åˆ¶å™¨é€é K8s API å»ºç«‹ä¸€æ¬¡æ€§ Jobï¼Œå•Ÿå‹• `cloudflared`ï¼Œä¸¦å›å‚³è‡¨æ™‚ URL

## Tech Stack
- Cloudflare Tunnel
- Node.js
- Kubernetes (GKE)

## æµç¨‹åœ–
![flowchart](../assets/post/tunnel-worker-controller/flowchart.png)

---

## 1 Job Manager è§¸ç™¼ K8s è³‡æºå»ºç«‹
é€éæœå‹™èˆ‡ K8s åŸç”Ÿ API Server äº’å‹•ï¼Œå‹•æ…‹å»ºç«‹ `Job`ã€‚

`job-manager.js`
```javascript
async function createJob() {
  return new Promise(async (resolve, reject) => {
    const token = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/token', 'utf8');
    const caCert = fs.readFileSync('/var/run/secrets/kubernetes.io/serviceaccount/ca.crt');
    
    const hostname = await getKubernetesApiHost();
    console.log(`å˜—è©¦åœ¨ ${hostname} å»ºç«‹ Job`);

    const postData = JSON.stringify({
      apiVersion: "batch/v1",
      kind: "Job",
      metadata: { name: "cf-job" },
      spec: {
        ttlSecondsAfterFinished: 10,
        template: {
          spec: {
            restartPolicy: "Never",
            containers: [
              {
                name: "tunnel",
                image: "tunnel:latest",
                command: ["/bin/sh", "-c"],
                args: ["cloudflared tunnel --url http://url:port & sleep 60;"],
                imagePullPolicy: "IfNotPresent"
              }
            ]
          }
        }
      }
    });

    const options = {
      hostname: hostname,
      port: 443,
      path: '/apis/batch/v1/namespaces/default/jobs',
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData),
      },
      ca: caCert,
    };

    const req = https.request(options, (res) => {
      let data = '';

      console.log(`ç‹€æ…‹ç¢¼: ${res.statusCode}`);

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        console.log('å›æ‡‰è³‡æ–™:', data);
        if (res.statusCode === 201) {
          resolve(data);
        } else {
          reject(new Error(`Job å»ºç«‹å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${res.statusCode}`));
        }
      });
    });

  });

}
```

## 2 ä½¿ç”¨å¯åŸ·è¡Œ cloudflared çš„ Image ä¾†å»ºç«‹ Job
`dockerfile.tunner`
```docker
FROM ubuntu:20.04

RUN apt-get update && apt-get install -y curl

# å®‰è£ cloudflared
RUN curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared \
    && chmod +x /usr/local/bin/cloudflared

# å°‡ä½ çš„æ‡‰ç”¨ç¨‹å¼æ”¾é€² containerï¼Œå‡è¨­åŸ·è¡Œåœ¨ 3000
# COPY app /app

EXPOSE 3000
CMD ["cloudflared", "version"]
```

## 3 å›å ±ç”¢ç”Ÿçš„ Cloudflared URL
åœ¨æ§åˆ¶å™¨è·¯ç”±ä¸­ï¼šå»ºç«‹ Job â†’ ç­‰ Pod Ready â†’ ç­‰ tunnel èµ·ä¾† â†’ æŠ“ logs â†’ æ“·å–è‡¨æ™‚ URL å›å‚³ã€‚

```javascript
app.post('/runjob', (req, res) => {
  console.log(`Cloudflared tunnel å°‡åœ¨ 3 ç§’å¾Œå•Ÿå‹•`);
  
  setTimeout(async() => {
    try {
      // å»ºç«‹ Job
      await createJob();
      console.log('Job å»ºç«‹æˆåŠŸï¼Œç­‰å¾… Pod å•Ÿå‹•...');
      
      // ç­‰å¾… Pod æº–å‚™å¥½
      const podName = await waitForPodReady('cf-job');
      if (!podName) {
        res.status(500).json({ error: 'Cloudflared tunnel å•Ÿå‹•å¤±æ•—ï¼šæ‰¾ä¸åˆ° Pod' });
        return;
      }
      
      // ç­‰å¾… tunnel å®Œå…¨å•Ÿå‹•
      console.log('Pod å·²å•Ÿå‹•ï¼Œç­‰å¾… tunnel å»ºç«‹...');
      await new Promise(r => setTimeout(r, 8000));
      
      // å–å¾— logs
      const logs = await getPodLogs(podName);
      console.log('Pod logs:', logs);
      
      // å¾ logs ä¸­æå– tunnel URL
      const match = logs.match(/https:\/\/[a-z0-9\-]+\.trycloudflare\.com/);
      if (!match) {
        throw new Error('æ‰¾ä¸åˆ° tunnel URL');
      }

      console.log(`æ‰¾åˆ° tunnel URL: ${match[0]}`);
      res.status(200).json({ tunnelUrl: match[0] });
      
    } catch (err) {
      console.error('éŒ¯èª¤:', err);
      res.status(500).json({ error: `Cloudflared tunnel å•Ÿå‹•å¤±æ•—: ${err.message}` });
    }
  }, 3000);
});
```

## 4 å¯¦éš›æ“ä½œ Logs
Pod å…§è§¸ç™¼:
```bash
<<K9s-Shell>> Pod: default/jobmanager | Container: jobmanager
/app # curl -X POST http://localhost:3000/runjob
{"tunnelUrl":"https://woods-appreciate-paying-felt.trycloudflare.com"}
```
æœå‹™ç«¯ Logs:
```log
âœ  tunnel git:(main) kubectl logs pods/jobmanager 
Server is running on port 3000
Cloudflared tunnel å°‡åœ¨ 3 ç§’å¾Œå•Ÿå‹•
å˜—è©¦åœ¨ 192.168.194.129 å»ºç«‹ Job
ç‹€æ…‹ç¢¼: 201
å›æ‡‰è³‡æ–™: {"kind":"Job","apiVersion":"batch/v1","metadata":{"name":"cf-job","namespace":"default","uid":"45744335-098f-4b66-94fd-883ae1d888b0","resourceVersion":"8637","generation":1,"creationTimestamp":"2025-06-12T06:50:48Z","labels":{"batch.kubernetes.io/controller-uid":"45744335-098f-4b66-94fd-883ae1d888b0","batch.kubernetes.io/job-name":"cf-job","controller-uid":"45744335-098f-4b66-94fd-883ae1d888b0","job-name":"cf-job"},"managedFields":[{"manager":"unknown","operation":"Update","apiVersion":"batch/v1","time":"2025-06-12T06:50:48Z","fieldsType":"FieldsV1","fieldsV1":{"f:spec":{"f:backoffLimit":{},"f:completionMode":{},"f:completions":{},"f:manualSelector":{},"f:parallelism":{},"f:podReplacementPolicy":{},"f:suspend":{},"f:template":{"f:spec":{"f:containers":{"k:{\"name\":\"tunnel\"}":{".":{},"f:args":{},"f:command":{},"f:image":{},"f:imagePullPolicy":{},"f:name":{},"f:resources":{},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{}}},"f:dnsPolicy":{},"f:restartPolicy":{},"f:schedulerName":{},"f:securityContext":{},"f:terminationGracePeriodSeconds":{}}},"f:ttlSecondsAfterFinished":{}}}}]},"spec":{"parallelism":1,"completions":1,"backoffLimit":6,"selector":{"matchLabels":{"batch.kubernetes.io/controller-uid":"45744335-098f-4b66-94fd-883ae1d888b0"}},"manualSelector":false,"template":{"metadata":{"creationTimestamp":null,"labels":{"batch.kubernetes.io/controller-uid":"45744335-098f-4b66-94fd-883ae1d888b0","batch.kubernetes.io/job-name":"cf-job","controller-uid":"45744335-098f-4b66-94fd-883ae1d888b0","job-name":"cf-job"}},"spec":{"containers":[{"name":"tunnel","image":"tunnel:latest","command":["/bin/sh","-c"],"args":["cloudflared tunnel --url http://server-service.default.svc.cluster.local:3000 \u0026 sleep 60;"],"resources":{},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","imagePullPolicy":"IfNotPresent"}],"restartPolicy":"Never","terminationGracePeriodSeconds":30,"dnsPolicy":"ClusterFirst","securityContext":{},"schedulerName":"default-scheduler"}},"ttlSecondsAfterFinished":10,"completionMode":"NonIndexed","suspend":false,"podReplacementPolicy":"TerminatingOrFailed"},"status":{}}

Job å»ºç«‹æˆåŠŸï¼Œç­‰å¾… Pod å•Ÿå‹•...
å˜—è©¦é€£æ¥ Kubernetes API: 192.168.194.129
å˜—è©¦é€£æ¥ Kubernetes API: 192.168.194.129
æ‰¾åˆ° Pod: cf-job-x65v9
Pod å·²å•Ÿå‹•ï¼Œç­‰å¾… tunnel å»ºç«‹...
å˜—è©¦å¾ 192.168.194.129 å–å¾— Pod logs
Pod logs: 2025-06-12T06:50:49Z INF Thank you for trying Cloudflare Tunnel. Doing so, without a Cloudflare account, is a quick way to experiment and try it out. However, be aware that these account-less Tunnels have no uptime guarantee, are subject to the Cloudflare Online Services Terms of Use (https://www.cloudflare.com/website-terms/), and Cloudflare reserves the right to investigate your use of Tunnels for violations of such terms. If you intend to use Tunnels in production you should use a pre-created named tunnel by following: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps
2025-06-12T06:50:49Z INF Requesting new quick Tunnel on trycloudflare.com...
2025-06-12T06:50:53Z INF +--------------------------------------------------------------------------------------------+
2025-06-12T06:50:53Z INF |  Your quick Tunnel has been created! Visit it at (it may take some time to be reachable):  |
2025-06-12T06:50:53Z INF |  https://woods-appreciate-paying-felt.trycloudflare.com                                    |
2025-06-12T06:50:53Z INF +--------------------------------------------------------------------------------------------+
2025-06-12T06:50:53Z INF Cannot determine default configuration path. No file [config.yml config.yaml] in [~/.cloudflared ~/.cloudflare-warp ~/cloudflare-warp /etc/cloudflared /usr/local/etc/cloudflared]
2025-06-12T06:50:53Z INF Version 2025.6.0 (Checksum 173276e3370f366493fb818ebe33cca23a9601d721ca3c03085b3f838eaf3ca9)
2025-06-12T06:50:53Z INF GOOS: linux, GOVersion: go1.24.2, GoArch: amd64
2025-06-12T06:50:53Z INF Settings: map[ha-connections:1 protocol:quic url:http://server-service.default.svc.cluster.local:3000]
2025-06-12T06:50:53Z INF Autoupdate frequency is set autoupdateFreq=86400000
2025-06-12T06:50:53Z INF Generated Connector ID: 60bce1a3-512e-4fc7-a13e-769605269cb0
2025-06-12T06:50:53Z INF Initial protocol quic
2025-06-12T06:50:53Z INF ICMP proxy will use 192.168.194.57 as source for IPv4
2025-06-12T06:50:53Z INF ICMP proxy will use fd07:b51a:cc66:a::39 in zone eth0 as source for IPv6
2025-06-12T06:50:53Z INF ICMP proxy will use 192.168.194.57 as source for IPv4
2025-06-12T06:50:53Z INF ICMP proxy will use fd07:b51a:cc66:a::39 in zone eth0 as source for IPv6
2025-06-12T06:50:53Z INF Starting metrics server on 127.0.0.1:20241/metrics
2025-06-12T06:50:53Z INF Tunnel connection curve preferences: [X25519MLKEM768 CurveID(25497) CurveP256] connIndex=0 event=0 ip=198.41.192.227
2025/06/12 06:50:53 failed to sufficiently increase receive buffer size (was: 208 kiB, wanted: 7168 kiB, got: 416 kiB). See https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes for details.
2025-06-12T06:50:54Z INF Registered tunnel connection connIndex=0 connection=7afeed09-acc7-4346-ab16-279c92bd901e event=0 ip=198.41.192.227 location=hkg01 protocol=quic

æ‰¾åˆ° tunnel URL: https://woods-appreciate-paying-felt.trycloudflare.com
âœ  tunnel git:(main) 
```

## Repo
æœ€å¾Œé †æ‰‹æŠŠæœå‹™çš„ Helm Chart ä¹Ÿå»ºç½®å¥½äº† ğŸ˜†<br/>
[Repo å‚³é€é–€](https://github.com/Sakuard/tunnel-worker-controller)

---
ğŸ“Œ é—œéµå­—ï¼šCloudflare Tunnelã€trycloudflareã€Zero Trustã€Kubernetesã€GKEã€Grafanaã€è‡¨æ™‚å¤–ç¶²å­˜å–ã€K8s Jobã€å‹•æ…‹éš§é“ã€Observability
