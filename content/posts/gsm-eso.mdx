---
title: ç”¨ Google Secret Manager èˆ‡ External Secret Operator ç®¡ç†æ©Ÿæ•è³‡æ–™
date: 2025-5-27 08:00:00 +0800
categories: [Blog, TechLog]
description: ç”¨ Google Secret Manager èˆ‡ External Secret Operator ç®¡ç†æ©Ÿæ•è³‡æ–™
tags: [Security, Operator, GSM, ESO]
---

## TL;DR
- Google Secret Manager[(GSM)](https://cloud.google.com/security/products/secret-manager) é›†ä¸­ç®¡ç†æ©Ÿæ•è³‡æ–™
- Workload Identity[(WI)](https://cloud.google.com/iam/docs/workload-identity-federation) çš„æ–¹å¼è³¦äºˆ External Secret Operator[(ESO)](https://external-secrets.io/latest/provider/google-secrets-manager/) è¨ªå• GSM çš„æ¬Šé™
- ESO åŒæ­¥ GKE & GSM çš„ secret

## èƒŒæ™¯
æœ‰äº›æœå‹™æœƒä½¿ç”¨åˆ°ç’°å¢ƒè®Šæ•¸ `.env`
ä»¥ `kind: secret` çš„æ–¹å¼éƒ¨ç½²ï¼Œåœ¨ç®¡ç†ä¸Šä¸ä¾¿

### GSM æ©Ÿæ•è³‡æ–™å»ºç«‹
åœ¨ Secret value çš„éƒ¨åˆ†ï¼Œæ˜¯ä»¥ `json` çš„æ ¼å¼å­˜æ”¾ `key-value`
![GSM example](../assets/post/security/GSM%20example.png)

### WI æˆäºˆæ¬Šé™
`WI` æ˜¯é€é Google ServiceAccount(GSA) èˆ‡ Kubernetes ServiceAccount(KSA) çš„ç¶å®šï¼Œè®“ `KSA` æ“æœ‰ `GSA` çš„æ¬Šé™åŒæ™‚ï¼Œé–“æ¥æˆäºˆæ“æœ‰è©² `KSA` çš„æœå‹™äº«æœ‰ç›¸åŒæ¬Šé™

ğŸ‘‰ å…ˆè³¦äºˆ GSA æ¬Šé™åŒæ™‚ï¼Œç¶å®š KSA
é€™é‚Šæ˜¯é€é IaC(terragrunt) çš„æ–¹å¼ï¼Œå»ºç«‹ GSA è³¦äºˆæ¬Šé™ï¼Œä¸¦ä¸”ç¶å®š KSA

```tf
# main.tf

resource "google_service_account" "sa" {
  project      = var.project_id
  account_id   = var.name
  display_name = var.display_name
  description  = var.description
}

resource "google_project_iam_member" "roles" {
  for_each = toset(var.project_roles)
  project  = var.project_id
  role     = each.value
  member   = google_service_account.sa.member
}

# Workload Identity ç¶å®šï¼šå…è¨± K8s SA impersonate GSA
resource "google_service_account_iam_member" "workload_identity" {
  service_account_id = google_service_account.sa.name
  role               = "roles/iam.workloadIdentityUser"
  member             = "serviceAccount:${var.project_id}.svc.id.goog[${var.k8s_namespace}/${var.k8s_sa_name}]"
}
```

```hcl
# terragrunt.hcl

  project_roles = [
    "roles/secretmanager.secretAccessor"                  # è¦–å¯¦éš›éœ€æ±‚èª¿æ•´
  ]

  k8s_namespace   = "external-secrets"                    # è¦–å¯¦éš›éƒ¨ç½²èª¿æ•´
  k8s_sa_name     = "external-secret-external-secrets"    # è¦–å¯¦éš›éƒ¨ç½²èª¿æ•´
```

### ESO éƒ¨ç½²
é€™é‚Šè¦æŒ‡æ˜ KSA æ‰€å°æ‡‰çš„ GSA æ¬Šé™ä¾†æº

å¯ä»¥åƒè€ƒ [ArtifactHub](https://artifacthub.io/packages/helm/external-secrets-operator/external-secrets?modal=values&path=webhook.serviceAccount) èˆ‡ [Github](https://github.com/external-secrets/external-secrets/blob/main/deploy/charts/external-secrets/templates/serviceaccount.yaml)
æ‰¾åˆ°æ€éº¼è¨­å®š

```yaml
serviceAccount:
  create: true
  annotations:
    iam.gke.io/gcp-service-account: "${GSA-name}@${GCP-project-id}.iam.gserviceaccount.com"
```

ğŸ‘‰ æ¥è‘—ï¼Œæˆ‘å€‘æœƒéœ€è¦ä¸€å€‹ ClusterSecretStore ä¾†è®“ ESO çŸ¥é“ `secret ä¾†æº`

æœƒéœ€è¦è¨­ç½®
1. project: GCP project-id
2. clusterLocation: GKE location
3. clusterName: GKE cluster name
```yaml
# ClusterSecretStore.yaml

{{- with .Values.createClusterSecretStore }}
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: {{ .name }}
  labels:
    project: {{ .project }}
spec:
  provider:
    gcpsm:
      projectID: {{ .project }}
      auth:
        workloadIdentity:
          clusterLocation: {{ .clusterLocation }}
          clusterName: {{ .clusterName }}
          serviceAccountRef:
            name: external-secret-external-secrets
            namespace: external-secrets
{{- end }}
```

åˆ°é€™é‚Šï¼Œæ‡‰è©²å¯ä»¥çœ‹åˆ°ä¸Šé¢é€™å€‹ ClusterSecretStore çš„ç‹€æ…‹è¦æ˜¯ True
```bash
# ç¯„ä¾‹

kubectl get clustersecretstores.external-secrets.io 

NAME                 AGE    STATUS   CAPABILITIES   READY
gcp-secret-manager   117m   Valid    ReadWrite      True
```

### æœå‹™å–å¾— GSM secret
æœå‹™ç«¯å‰‡æ˜¯å»ºç«‹å¥½ `ExternalSecret` å¾Œï¼Œå‰©ä¸‹çš„ dirty work `ESO` æœƒå¹«æˆ‘å€‘è™•ç†å¥½

åœ¨ `ExternalSecret` ä¸­æœƒæœ‰å¹¾é …éœ€è¦ defineï¼š
1. refreshInterval: æ›´æ–°æ™‚é–“
2. secretStoreRef: åƒè€ƒçš„é¡å‹(æ–‡ç« ä½¿ç”¨ ClusterSecretStore)ï¼Œä»¥åŠå»ºç«‹æ™‚çš„åå­—
3. target: å»ºç«‹çš„ secret åç¨±
4. dataFrom: è³‡æ–™ä¾†æº(GSM çš„ secret name)


```yaml
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .name }}
  namespace: {{ .namespace }}
spec:
  # é€™å°‡ã€Œæ¯1åˆ†é˜ã€åˆ·æ–°ä¸€æ¬¡é‡‘é‘°ã€‚å¯ä»¥æ ¹æ“šè‡ªå·±çš„è¦æ±‚ä¿ç•™æ™‚é–“ã€‚
  refreshInterval: {{ .refreshInterval }}
  secretStoreRef:
    name: {{ .secretStoreRef.name }}
    kind: {{ .secretStoreRef.kind }}
  target:
    name: {{ .target.name }}
    creationPolicy: {{ .target.creationPolicy }}
  dataFrom:
    - extract:
        key: {{ .target.name }}
```

å¾ŒçºŒ ESO æœƒé€éä¸Šè¿°è¨­å®šï¼Œåˆ° GSM å–å€¼ï¼Œä¸¦ä¾ç…§ ExternalSecret çš„è¨­å®šï¼Œåˆ°æŒ‡å®š ns å»ºç«‹ secret
```bash
# ç¯„ä¾‹

kubectl -n cosparks describe secret kk   
Name:         kk
Namespace:    ${namespace}
Labels:       app.kubernetes.io/managed-by=Helm
              reconcile.external-secrets.io/managed=true
Annotations:  meta.helm.sh/release-name: ${server}
              meta.helm.sh/release-namespace: ${namespace}

Type:  Opaque

Data
====
kk:    12 bytes
ping:  4 bytes
```

ğŸ‘‰ ä¸¦ç¢ºèªæœå‹™æœ‰åƒåˆ°åƒæ•¸
![demo](../assets/post/security/demo.png)
```javascript
const dotenv = require('dotenv');
dotenv.config();

app.get('/', (req, res) => {
    res.send(`Hello CoSparks, ${process.env.kk}`);
});
```
---
åŒæ™‚ `GSM` è‹¥æ›´æ–°ï¼Œ `ESO` æœƒä¾ç…§ `refreshInterval`
æ›´æ–° `K8s` å…§çš„ `secret`
å¾ŒçºŒæœå‹™åªéœ€è¦é‡å•Ÿï¼Œå°±å¯ä»¥åƒåˆ°æ–°å¾Œçš„ `secret`
