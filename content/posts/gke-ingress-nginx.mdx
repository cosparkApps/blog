---
title: åœ¨ GKE ä¸Šä½¿ç”¨ ingress-nginx ç®¡ç†æµé‡ï¼šæ¶æ§‹èˆ‡å¯¦å‹™é…ç½®
description: åœ¨ GKE ä¸Šé€é ingress-nginx ç®¡ç†æœå‹™æµé‡ï¼ŒåŒ…å« Helm éƒ¨ç½²ã€L4 Load Balancer å»ºç«‹ã€Ingress path å°æµèˆ‡æœå‹™ SVC é…ç½®ã€‚é™„ä¸Šå®Œæ•´æ¶æ§‹åœ–èˆ‡ request flow è¦–è¦ºåŒ–è§£æã€‚
date: 2025-07-29 22:35:00 +0800
tags: [K8s, GKE, ingress-nginx, Kubernetes Networking, Load Balancer, Ingress Controller, Traffic Management]
---

## TL;DR
Techporn å¹³å°åœ¨ **GKE (Google Kubernetes Engine)** ä¸Šï¼Œåˆ©ç”¨ `ingress-nginx` æ§åˆ¶æµé‡çš„éƒ¨ç½²èˆ‡å°æµæ©Ÿåˆ¶ã€‚

---

## èƒŒæ™¯
æˆ‘å€‘é¸æ“‡ GKE ä½œç‚ºä¸»è¦æœå‹™éƒ¨ç½²å¹³å°ï¼Œä¸¦ä½¿ç”¨ `ingress-nginx` ä¾†é€²è¡Œæµé‡æ§åˆ¶èˆ‡æœå‹™å°æµã€‚

---

## æ ¸å¿ƒå…ƒä»¶ï¼šIngress-Nginx
é€é `Helm` éƒ¨ç½²çš„ ingress-nginxï¼Œæœƒå»ºç«‹ä¸€å€‹ `ingress-nginx-controller`ï¼Œè² è²¬ç®¡ç†æ‰€æœ‰ Ingress è³‡æºã€‚  

åƒè€ƒæŒ‡ä»¤:
```sh
âœ helm diff ingress-nginx ingress-nginx/ingress-nginx --namespace ingress-nginx --allow-unreleased
Command "helm diff" is deprecated, use "helm diff upgrade" instead
********************

        Release was not present in Helm.  Diff will show entire contents as new.

********************
ingress-nginx, ingress-nginx, ClusterRole (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/clusterrole.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: ClusterRole
+ metadata:
+   name: ingress-nginx
+   labels:
+   ... ç•¥
ingress-nginx, ingress-nginx, ClusterRoleBinding (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/clusterrolebinding.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: ClusterRoleBinding
+ metadata:
+   name: ingress-nginx
+   ... ç•¥
ingress-nginx, ingress-nginx, Role (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/controller-role.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: Role
+ metadata:
+   name: ingress-nginx
+   namespace: ingress-nginx
+   labels:
+   ... ç•¥
ingress-nginx, ingress-nginx, RoleBinding (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/controller-rolebinding.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: RoleBinding
+ metadata:
+   labels:
+   ... ç•¥
ingress-nginx, ingress-nginx, ServiceAccount (v1) has been added:
- 
+ # Source: ingress-nginx/templates/controller-serviceaccount.yaml
+ apiVersion: v1
+ kind: ServiceAccount
+ metadata:
+   labels:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission, ClusterRole (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: ClusterRole
+ metadata:
+   name: ingress-nginx-admission
+   annotations:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission, ClusterRoleBinding (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: ClusterRoleBinding
+ metadata:
+   name: ingress-nginx-admission
+   annotations:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission, Role (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: Role
+ metadata:
+   name: ingress-nginx-admission
+   namespace: ingress-nginx
+   annotations:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission, RoleBinding (rbac.authorization.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml
+ apiVersion: rbac.authorization.k8s.io/v1
+ kind: RoleBinding
+ metadata:
+   name: ingress-nginx-admission
+   namespace: ingress-nginx
+   annotations:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission, ServiceAccount (v1) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml
+ apiVersion: v1
+ kind: ServiceAccount
+ metadata:
+   name: ingress-nginx-admission
+   namespace: ingress-nginx
+   annotations:
+   ... ç•¥
+   labels:
+   ... ç•¥
+ automountServiceAccountToken: true
ingress-nginx, ingress-nginx-admission, ValidatingWebhookConfiguration (admissionregistration.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml
+ # before changing this value, check the required kubernetes version
+ # https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites
+ apiVersion: admissionregistration.k8s.io/v1
+ kind: ValidatingWebhookConfiguration
+ metadata:
+   annotations:
+   labels:
+   ... ç•¥
+   name: ingress-nginx-admission
+ webhooks:
+   - name: validate.nginx.ingress.kubernetes.io
+   ... ç•¥
ingress-nginx, ingress-nginx-admission-create, Job (batch) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml
+ apiVersion: batch/v1
+ kind: Job
+ metadata:
+   name: ingress-nginx-admission-create
+   namespace: ingress-nginx
+   annotations:
+   ... ç•¥
+ spec:
+   ... ç•¥
ingress-nginx, ingress-nginx-admission-patch, Job (batch) has been added:
- 
+ # Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml
+ apiVersion: batch/v1
+ kind: Job
+ metadata:
+   name: ingress-nginx-admission-patch
+   namespace: ingress-nginx
+   annotations:
+   ... ç•¥
+ spec:
+   ... ç•¥
ingress-nginx, ingress-nginx-controller, ConfigMap (v1) has been added:
- 
+ # Source: ingress-nginx/templates/controller-configmap.yaml
+ apiVersion: v1
+ kind: ConfigMap
+ metadata:
+   labels:
+   ... ç•¥
+   name: ingress-nginx-controller
+   namespace: ingress-nginx
+ data:
ingress-nginx, ingress-nginx-controller, Deployment (apps) has been added:
- 
+ # Source: ingress-nginx/templates/controller-deployment.yaml
+ apiVersion: apps/v1
+ kind: Deployment
+ metadata:
+   labels:
+   ... ç•¥
+   name: ingress-nginx-controller
+   namespace: ingress-nginx
+ spec:
+   ... ç•¥
ingress-nginx, ingress-nginx-controller, Service (v1) has been added:
- 
+ # Source: ingress-nginx/templates/controller-service.yaml
+ apiVersion: v1
+ kind: Service
+ metadata:
+   annotations:
+   labels:
+   ... ç•¥
+   name: ingress-nginx-controller
+   namespace: ingress-nginx
+ spec:
+   ... ç•¥
ingress-nginx, ingress-nginx-controller-admission, Service (v1) has been added:
- 
+ # Source: ingress-nginx/templates/controller-service-webhook.yaml
+ apiVersion: v1
+ kind: Service
+ metadata:
+   labels:
+   ... ç•¥
+ spec:
+   ... ç•¥
ingress-nginx, nginx, IngressClass (networking.k8s.io) has been added:
- 
+ # Source: ingress-nginx/templates/controller-ingressclass.yaml
+ apiVersion: networking.k8s.io/v1
+ kind: IngressClass
+ metadata:
+   labels:
+   ... ç•¥
+   name: nginx
+ spec:
+   controller: k8s.io/ingress-nginx
```

åŒæ™‚ï¼ŒGCP æœƒå»ºç«‹ä¸€å€‹ **L4 Load Balancer** ä¾†æ‰¿æ¥å¤–éƒ¨æµé‡ã€‚ 

æ¥è‘—è¨­ç½® ingressClass
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    meta.helm.sh/release-name: docs
    meta.helm.sh/release-namespace: cosparks
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "2"
    nginx.ingress.kubernetes.io/limit-connections: "10"
    nginx.ingress.kubernetes.io/limit-rpm: "600"
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  creationTimestamp: "2025-09-19T10:13:53Z"
  generation: 4
  labels:
    app.kubernetes.io/managed-by: Helm
  name: docs-ingress
  namespace: cosparks
  resourceVersion: "1758279423886847006"
  uid: ea607a0f-948b-4046-97be-1c1c2e320fd3
spec:
  ingressClassName: nginx
  rules:
  - host: docs.cosparks.app
    http:
      paths:
      - backend:
          service:
            name: docs
            port:
              number: 80
        path: /
        pathType: Prefix
```

æ¶æ§‹åœ–å¦‚ä¸‹ï¼š  
```mermaid
graph LR
    subgraph GCP
        lb(L4 LoadBalancer)
    end

    subgraph GKE
        subgraph ingress-nginx
        igc(ingress-nginx controller)
        end
        ig(ingress)
    end
    lb --> igc --> |è—‰ç”± ingressClass<br/>è­˜åˆ¥å€’è½‰| ig
```

å°æ‡‰çš„ `Load Balancer` è¨­å®šç•«é¢ï¼š  
![LB](../assets/post/GKE-ingress-nginx/LB-config.png)

---

## Ingress å°æµé…ç½®
æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘æœƒåœ¨æœå‹™çš„ `Ingress` ä¸­è¨­å®š **path èˆ‡å°æ‡‰çš„ Service (SVC)**ï¼Œè®“ ingress-nginx çŸ¥é“å¦‚ä½•æ­£ç¢ºå°æµã€‚  

ç¯„ä¾‹å¦‚ä¸‹ï¼š  
![ingress_config](../assets/post/GKE-ingress-nginx/ingress-config.png)

åŠ å…¥æœå‹™æ¶æ§‹åœ–å¾Œï¼š  
```mermaid
graph LR
    subgraph GCP
        lb(L4 LoadBalancer)
    end

    subgraph GKE
        subgraph ingress-nginx
        igc(ingress-nginx controller)
        end
        subgraph Service
        igc -->|è—‰ç”± ingressClass<br/>è­˜åˆ¥å€’è½‰| ig(ingress) --> svc(æœå‹™ SVC) --> service(Service)
        end
    end
    lb --> igc
```

å› æ­¤å®Œæ•´çš„ request flow å¦‚ä¸‹ï¼š  
```mermaid
graph LR
http(http request) --> lb(L4 Load-Balancer) --> ig(ingress) --> svc(æœå‹™ SVC) --> service(Service)
```

---

## DNS è§£æ
æ˜¯å¦éœ€è¦é…ç½® **DNS**ï¼Œå–æ±ºæ–¼æœå‹™æ˜¯å¦ç¶å®š Domainï¼š  
- è‹¥æœ‰ç¶å®š Domain â†’ éœ€è¨­å®š DNS è§£æè‡³ Load Balancer  
- è‹¥ç„¡ Domain â†’ å¯ç›´æ¥ä½¿ç”¨ Load Balancer IP å­˜å–  

---

ğŸ“Œ **é—œéµå­—**ï¼šGKEã€Kubernetesã€Ingress-Nginxã€Load Balancerã€Ingress Controllerã€æµé‡ç®¡ç†ã€Helm éƒ¨ç½²ã€GCP Networkingã€Service SVCã€Traffic Routing
