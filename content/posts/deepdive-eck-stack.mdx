---
title: æ·±å…¥ç ”ç©¶ eck-stack çš„ç›£æ§èˆ‡é‹ç¶­
date: 2025-08-18 10:00:00 +0800
categories: [Blog, TechLog]
description: æ·±å…¥ç ”ç©¶ eck-stack çš„ç›£æ§èˆ‡é‹ç¶­
tags: [K8s, GKE, eck-stack]
---

## TL;DR
- Datadog åœ¨è’é›† eck-stack metrics çš„å‘
- ä¸€äº›é‹ç¶­ç´€éŒ„
- [Datadog ElasticSearch Integration](https://docs.datadoghq.com/integrations/elasticsearch/?tab=host#data-collected)
- [Elasticsearch Metrics](https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-nodes-stats)

## èƒŒæ™¯
å…¬å¸ RD ä½¿ç”¨ eck-stack ä½œç‚ºæŸå€‹åŠŸèƒ½æœå‹™çš„ DB
å› æ­¤é™¤äº†æœå‹™çš„æ¶è¨­ï¼ŒåŒç ”ç©¶äº†ä¸€ä¸‹ ES é€™å€‹æœå‹™ï¼Œè©²æ€éº¼ç›£æ§æ¯”è¼ƒå¥½
â— å¦å¤–éœ€è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ eck-stack æ˜¯ä¸€å¥— `Operator-base` çš„å·¥å…·
â— ä½¿ç”¨ä¸Šï¼Œå¯èƒ½éœ€è¦è©•ä¼°æ˜¯å¦æœ‰è¶³å¤ çš„é‹ç¶­æŠ€è¡“é‡èƒ½


### [Architecture](https://www.elastic.co/docs/deploy-manage/distributed-architecture/clusters-nodes-shards/node-roles)
eck-stack çš„ cluster åœ¨ node åˆ†æˆä¸åŒåŠŸèƒ½ï¼Œåˆ†åˆ¥æ˜¯
- Master(`master`): æœƒé¸å‡º Leader ä¾†ç®¡ç† cluster
- Data: åŒ…å« (`data`, `data_content`, `data_hot`, `data_warm`, `data_cold`, `data_frozen`) æä¾›ä¸åŒåŠŸèƒ½çš„è³‡æ–™å„²å­˜
- Ingest(`ingest`): ç”¨æ–¼è³‡æ–™ pipeline çš„è™•ç†
- Remote_cluster_client(`remote_cluster_client`): ä¼¼ä¹å¯ä»¥ç”¨æ–¼æ©‹æ¥ä¸åŒ eck-cluster
- Machine learning(`ml`): ä¸»è¦ç”¨æ–¼ ML
- Transform node (`transform`): å°ç¾æœ‰çš„ indices data åšè³‡æ–™è½‰æ›

### æœå‹™ç›£æ§
åŸºæ–¼å° `ElasticSearch` çš„äº†è§£ `Java base`, `Query & Response`
åœ¨ Metrics çš„è’é›†è¦åŠƒä¸Šï¼Œæ‡‰è©²æœƒéœ€è¦é‡å° `JVM`, `Query Latency` ä¾†è©•ä¼°ç›®å‰çš„æœå‹™æ€§èƒ½èˆ‡ç‹€æ…‹

âœ… CPU/JVM
![CPU/JVM](../assets/post/deepdive-eck-stack/monitoring_cpu-jvm.png)
|Name|Metrics|Description|monitoring point|
|-|-|-|-|
|Heap Memory|jvm.mem.heap_in_use| JVM ç›£æ§é‡é»|
|CPU usage|elasticsearch.process.cpu.percent|ECK æœ¬èº«æš´éœ²çš„ CPU metrics|
|thread count|jvm.threads.count|ES å…§ç•¶å‰çš„ thread æ•¸é‡|
|GC young|jvm.gc.collectors.young.collection_time|JVM çš„ young GC|è¶Šå¹³ç©©è¶Šå¥½|
|GC old|jvm.gc.collectors.old.collection_time|JVM çš„ young GC|æ‡‰è©²è¶¨è¿‘æ–¼ 0|

âœ… APM
![APM](../assets/post/deepdive-eck-stack/monitoring_apm.png)
|Name|Metrics|Description|monitoring point|
|-|-|-|-|
|task queue|elasticsearch.thread_pool.*.queue| ES å„å¼ä»»å‹™ queue ç‹€æ…‹||
|task active|elasticsearch.thread_pool.*.active| ES é‹ä½œçš„ thread||
|task reject|elasticsearch.thread_pool.*.rejected| ES è¢«æ‹’çµ•çš„ä»»å‹™æ•¸é‡||
|query time|elasticsearch.search.query.time|ES åœ¨ query èŠ±è²»çš„æ™‚é–“||
|breaker tripped|elasticsearch.breakers.fielddata.tripped|æŸ¥è©¢å¤±æ•—æ¬¡æ•¸||
|indexing current|elasticsearch.indexing.index.current|æ­£åœ¨è™•ç†çš„ index æ•¸é‡||
|indexing time count|elasticsearch.indexing.index.time.count|indexing è²»æ™‚||

âœ… Cluster Info
![cluster-info](../assets/post/deepdive-eck-stack/monitoring_cluster-info.png)
|Name|Metrics|Description|monitoring point|
|-|-|-|-|
|Node count|elasticsearch.number_of_nodes|ES Cluster Node æ•¸é‡||
|(a)ç¡¬ç¢Ÿå·²ä½¿ç”¨ç©ºé–“|kubernetes.kubelet.volume.stats.used_bytes||||
|(b)ç¡¬ç¢Ÿå¯ç”¨ç©ºé–“|kubernetes.kubelet.volume.stats.capacity_bytes||||
|ç¡¬ç¢Ÿä½¿ç”¨ç‡| (a) / (b) |é€é Func è¨ˆç®—å–å¾—||
|task pending|elasticsearch.pending_tasks_total|å¾…åŸ·è¡Œçš„ä»»å‹™||
|search count|elasticsearch.search.fetch.total.count|å–®ä½æ™‚é–“å…§ search æ¬¡æ•¸||
|Node ç‹€æ…‹|elasticsearch.cluster_status||||

### æœå‹™é‹ç¶­
#### â— hot-spot
ç•¢ç«Ÿè³‡æ–™æ˜¯ä»¥ index é…åˆ sharding çš„æ–¹å¼å„²å­˜
æœƒéœ€è¦é¡å¤–ç•™å¿ƒï¼Œæœ‰æ©Ÿæœƒå‡ºç¾ `è³‡æ–™ç†±é»` é€ æˆçš„å–®ä¸€ Data-node å£“åŠ›

#### â— JVM config
åœ¨åšè³‡æºèª¿æ•´æ™‚å€™ï¼Œæœ‰æ³¨æ„åˆ°èª¿æ•´ Master Node çš„ JVM config
ä¹Ÿæœƒé€£å¸¶å½±éŸ¿å…¶ä»– Node çš„ JVM ä½¿ç”¨ç‡

#### â— è³‡æ–™
ğŸ‘‰ Disk-Resize [reference-link](https://discuss.elastic.co/t/resize-disk-of-a-stateful-set/219758)
eck-stack çš„ ElasticSearch Cluster å¦‚æœè¦ resize ç¡¬ç¢Ÿå¤§å°éœ€è¦
1. è¨­ç½®å°æ‡‰ node ç¾¤é›†çš„ç¡¬ç¢Ÿè³‡æº
2. é‡æ–°å°è©² node ç¾¤é›†å‘½å

ç‚ºäº†ç¢ºä¿å„²å­˜çš„è³‡æ–™æ­£å¸¸ï¼Œå¯ä»¥åˆ° `Kibana` >> `Stack Management` >> `Index Management` ä¾†çœ‹ç•¶ä¸‹è³‡æ–™çš„ Indices æƒ…æ³
![ES index](../assets/post/deepdive-eck-stack/es-index.png)
å° data node ç¡¬ç¢Ÿ resize
![data-resize](../assets/post/deepdive-eck-stack/data-resize.png)
![resize-process](../assets/post/deepdive-eck-stack/resize-process.png)
![pvc-resize](../assets/post/deepdive-eck-stack/pvc-resize.png)
å¾ç›£æ§å¯ä»¥çœ‹åˆ°ä½¿ç”¨ç‡ç¢ºå¯¦æå‡
![disk-usaged](../assets/post/deepdive-eck-stack/disk-usaged.png)
Indices ç‹€æ…‹ä¹Ÿéƒ½æ˜¯å¥åº·çš„
![indice-info](../assets/post/deepdive-eck-stack/indice-info.png)



## â“ è¸©å‘èˆ‡å•é¡Œæ’æŸ¥

### ä½¿ç”¨ Datadog integration ä¾†è’é›† metrics å»ç™¼ç¾åœ¨ Dashboard æ‰¾ä¸åˆ°ï¼Ÿ
`ElasticSearch` expose å‡ºä¾†çš„ metrics ä¸­åŒ…å«äº† `cluster_name` é€™å€‹ tag
ä¸¦è³¦äºˆ `elasticsearch` é€™å€‹å€¼ï¼Œç¢°å·§æ’åäº†
![same-tag-key](../assets/post/deepdive-eck-stack/same-tag-key.png)
å°æ­¤ï¼Œ Datadog [intergration-core](https://github.com/DataDog/integrations-core/blob/master/elastic/datadog_checks/elastic/data/conf.yaml.example#L135) æœ‰æåˆ°ç›¸é—œèªªæ˜
ä½†å¯¦æ¸¬çµæœç‚º `metrics` å…¨éƒ¨æ¶ˆå¤±
![disable_legacy_cluster_tag](../assets/post/deepdive-eck-stack/disable_legacy_cluster_tag.png)

å› æ­¤æš«æ™‚é¡å¤–æ‰“ä¸Š `cluster_name` çš„ tag ä½¿å…¶å¯ä»¥è¢«æœå°‹
![retag](../assets/post/deepdive-eck-stack/retag.png)
![re-tag](../assets/post/deepdive-eck-stack/re-tag.png)


## æ’æŸ¥éç¨‹ç´€éŒ„
å–®ç´”çš„ä¸€äº› logï¼Œä¿ç•™ç´€éŒ„éƒ¨åˆ†æŸ¥è©¢è³‡æ–™èˆ‡ç•¶æ™‚æ¸¬è©¦çš„æ‰‹æ³•
å¯¦éš›å•é¡Œï¼Œå·²èˆ‡ä¸‹åˆ—ç„¡é—œ

- [Datadog ElasticSearch Integration](https://docs.datadoghq.com/integrations/elasticsearch/?tab=host#data-collected)
- [Elasticsearch Metrics](https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-nodes-stats)

```
 curl -k -u elastic:xxx https://elasticsearch-es-http.eck-stack.svc:9200/_nodes/stats/jvm,os,indices
```
Elasticsearch çš„åº•å±¤æ˜¯ç”¨ Java å»ºæ§‹
æ•…é‚„æ˜¯æœƒæœ‰ JVM Heap_memory ç­‰ç›¸é—œå•é¡Œ
æ•…ï¼Œåœ¨ monitoring ä¸Šä¸»è§€èªç‚ºä¸‹åˆ— metrics æ˜¯å¿…è¦çš„
1. fetch.total
2. jvm
3. latency

ç”± fetch.total å¯ä»¥çŸ¥é“ç•¶ä¸‹ query çš„éœ€æ±‚é‡
åŒæ­¥ç¢ºèª jvm çš„ heap_memory å°æ–¼ query çš„è®ŠåŒ–
ä¸¦è§€å¯Ÿ query æ˜¯å¦æœ‰ç”¢ç”Ÿ latency
ä¾†ç¢ºèªæœå‹™é‹è¡Œçš„æƒ…æ³

### é¦–å…ˆ

ä¸€é–‹å§‹é€²åˆ°æœå‹™ä¸‹ `agent check elastic` æ‰¾ä¸åˆ°ç›¸é—œ metrics
![metrics-missing](../assets/post/deepdive-eck-stack/metrics-missing.png))
å¾åœ–ä¸­æåˆ°
```
Skipping, open /opt/datadog-agent/bin/agent/dist/conf.d: no such file or directory
```

æ•…ï¼Œå…ˆç¢ºèªæ˜¯å¦å¯ä»¥å¾ elasticsearch æœå‹™å–å¾— metrics

ç”±æ–¼æœå‹™å·²åŠ ä¸Š datadoghq.checks çš„ annotatino ä¹‹å¾Œï¼Œé‚„æ˜¯ç„¡æ³•æ”¶åˆ°å®Œæ•´çš„ metrics
å¾ŒçºŒæ‰¾åˆ°å¯ä»¥åœ¨ datadog-agent ä¸Šè¨­ç½®ç›¸é—œ config
[agent-config åƒè€ƒ](https://github.com/DataDog/helm-charts/blob/main/charts/datadog/README.md#confd-and-checksd)
```
datadog:
  confd:
    redisdb.yaml: |-
      ad_identifiers:
        - redis
        - bitnami/redis
      init_config:
      instances:
        - host: "%%host%%"
          port: "%%port%%"
    jmx.yaml: |-
      ad_identifiers:
        - openjdk
      instance_config:
      instances:
        - host: "%%host%%"
          port: "%%port_0%%"
    redisdb.yaml: |-
      init_config:
      instances:
        - host: "outside-k8s.example.com"
          port: 6379
```

æ•…å˜—è©¦åœ¨å°æ‡‰çš„ datadog åŠ ä¸Š
![datadog-agent_confd](../assets/post/deepdive-eck-stack/datadog-agent_confd.png)
![datadog-agent_confd-ref](../assets/post/deepdive-eck-stack/datadog-agent_confd-ref.png)

ç›¸é—œ eck-stack çš„ metrics å–å¾— [åƒè€ƒ](https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-nodes-stats?utm_source=chatgpt.com)
