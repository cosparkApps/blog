---
title: ç”¨ Docker BuildKit æ›¿æ› Kaniko
description: Kaniko å·²åœæ­¢ç¶­è­·ï¼Ÿå¦‚ä½•ä»¥ Docker BuildKit å–ä»£ã€‚å¾åŸç†ã€cache æ©Ÿåˆ¶åˆ° GitLab CI å¯¦ä½œç¯„ä¾‹ã€‚
date: 2025-10-14 10:30:00 +0800
categories: [Blog, TechLog]
tags: [Docker, BuildKit, Kaniko, CI/CD, GitLab, Container Build, Cache]
---

## TL;DR
åŸæœ¬ä½¿ç”¨çš„ **Kaniko** å·²ç¶“ Archived<br/>
Survey **Dcoker BuildKit**<br/>
åŒ…å« `Command Line`, `Cache`, `GitLab-CI` èˆ‡ç›¸é—œè¨­å®š

## Docker BuildKit æ¦‚è§€

### BuildKit ç›¸æ¯”å‚³çµ± Docker çš„å„ªåŒ–
å¯ä»¥è™•ç†æ›´è¤‡é›œçš„æƒ…å¢ƒï¼ŒåŒ…å«
- è·³éæœªä½¿ç”¨çš„ Stage
- å¹³è¡Œæ‰“åŒ…ç„¡ç›¸ä¾æ€§çš„ Stage
- åƒ…åŒæ­¥æœ‰ç•°å‹•çš„æª”æ¡ˆè‡³ Stage
- åƒ…åŒæ­¥ `build context` å…§æœ‰è¢«ä½¿ç”¨åˆ°çš„æª”æ¡ˆ

### BuildKit æ˜¯ä»€éº¼ï¼Ÿ
BuildKit æ˜¯ `Low-Level Build(LLB)`
ä¾‹å¦‚ `Dockerfile` æˆ– `Mockerfile` éƒ½ç¶“éç·¨è­¯æˆ LLB å¾Œï¼Œæ‰å¯¦éš›åŸ·è¡Œæ‰“åŒ…å»ºæ§‹
![convert-export](../assets/post/kaniko-to-buildkit/convert-export.png)

### ä¸‰ç¨® Docker build æŒ‡ä»¤æ¯”è¼ƒ

- docker buildx build
  - å…¶ä¸­æœ€ High-Level çš„æŒ‡ä»¤
  - âŒ éœ€è¦ Daemon
  - âŒ ä¸æ”¯æ´ root-less
- buildctl build
  - æ¯”èµ· docker build ç¨ç‚ºæ›´ä½éšä¸€é»
  - âŒ éœ€è¦ Daemon
  - âŒ ä¸æ”¯æ´ root-less
- buildctl-daemonless.sh build
  - å…¶ä¸­æœ€ä½éš
  - âœ… ç„¡éœ€ Daemon
  - âœ… æ”¯æ´ root-less

```bash
##### æŒ‡ä»¤ç¯„ä¾‹ #####

# Traditional Docker
docker buildx build -t myimage:latest . --push

# buildctl
buildctl build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=image,name="myimage:latest",push=true

# daemonless
buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=image,name="myimage:latest",push=true
```

### Cache æ©Ÿåˆ¶
```dockerfile
# syntax=docker/dockerfile:1
FROM ubuntu:latest

RUN apt-get update && apt-get install -y build-essentials
COPY main.c Makefile /src/
WORKDIR /src/
RUN make build
```
ç•¶æœ‰ä»»ä½•ä¸€å€‹ Layer çš„å…§å®¹è®Šå‹•ï¼Œè©² Layer èˆ‡å¾ŒçºŒ Layer æœƒéœ€è¦ re-build
![docker-layer](../assets/post/kaniko-to-buildkit/docker-layer.png
)
ä¾‹å¦‚ `main.c` çš„å…§å®¹ç•°å‹• â†’ `COPY` ä¹‹å¾Œçš„ Layer çš†éœ€ re-build
![cache-layer](../assets/post/kaniko-to-buildkit/cache-layer.png)

[Cache ç¨®é¡](https://docs.docker.com/build/cache/backends/)
![cache-type](../assets/post/kaniko-to-buildkit/cache-type.png)

### æŒ‡ä»¤ç¯„ä¾‹

```bash
##### ä¸€èˆ¬æƒ…å¢ƒ #####
tree
.
â”œâ”€â”€ main.c
â”œâ”€â”€ Makefile
â””â”€â”€ Dockerfile

buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=image,name="myimage:latest",push=true


##### ç•¶ Dockerfile ä¸åœ¨ root #####
tree
.
â”œâ”€â”€ build
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ main.c
â””â”€â”€ Makefile

buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --opt filename=build/Dockerfile \
    --output type=image,name="myimage:latest",push=true

##### å»ºç«‹ cache #####
tree
.
â”œâ”€â”€ main.c
â”œâ”€â”€ Makefile
â””â”€â”€ Dockerfile

CACHE_IMAGE=$CI_REGISTRY_IMAGE:cache
buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --export-cache type=registry,ref=$CACHE_IMAGE \
    --import-cache type=registry,ref=$CACHE_IMAGE \
    --output type=image,name="myimage:latest",push=true

##### å»ºæ§‹å¤šå¹³è‡º #####
buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --opt platform=linux/amd64,linux/arm64 \
    --output type=image,name="myimage:latest",push=true

##### åƒæ•¸å¸¶å…¥ #####
buildctl-daemonless.sh build \
    --frontend dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --build-arg no_proxy=$no_proxy \
    --output type=image,name="myimage:latest",push=true

```
GitLab-CI ç¯„ä¾‹
```yaml
build:
  stage: build
  image: moby/BuildKit:rootless
    name: BuildKit
    entrypoint: [""]
  variables:
    DOCKERFILE_PATH: "build/Dockerfile"
    CACHE_IMAGE: $CI_REGISTRY_IMAGE:cache
    BuildKitD_FLAGS: --oci-worker-no-process-sandbox
  script:
    - !reference [.docker-login]
    - !reference [.prepare-image-name]
    - |
      buildctl-daemonless.sh build \
        --frontend dockerfile.v0 \
        --local context=. \
        --local dockerfile=. \
        --opt filename=${DOCKERFILE_PATH} \
        --export-cache type=registry,ref=$CACHE_IMAGE \
        --import-cache type=registry,ref=$CACHE_IMAGE \
        --output type=image,name=$IMAGE_WITH_TAG,push=true
  allow_failure: false
```

### æŒ‡ä»¤åƒæ•¸èªªæ˜

Docker context: è®“ Docker çŸ¥é“èƒ½ access çš„æª”æ¡ˆç¯„åœ
```
docker build [OPTIONS] PATH | URL
                       ^^^^^^^^^^
```
---
ğŸ“Œ é—œéµå­—ï¼šDocker BuildKitã€Kaniko æ›¿ä»£æ–¹æ¡ˆã€buildctlã€daemonlessã€GitLab CIã€container buildã€Docker cacheã€multi-platform buildã€moby/BuildKitã€CI/CD pipelineã€buildx
