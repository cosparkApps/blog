---
title: æ·±å…¥ç ”ç©¶ stdout log æ”¶é€åˆ° OpenSearch
date: 2025-08-19 15:00:00 +0800
categories: [Blog, TechLog]
description: log system è©•ä¼°åŠé‹ç¶­ç ”ç©¶
tags: [K8s, GKE, Elasticsearch, OpenSearch, logging, Daemonset, Sidecar]
---

## TL;DR
- log system è©•ä¼°åŠé‹ç¶­ç ”ç©¶

## èƒŒæ™¯èˆ‡æŒ‘æˆ°
å…¬å¸ç¾æœ‰çš„ä¸»è¦ç›£æŽ§ç³»çµ± `Datadog` æœƒåŽ»æ”¶é›†æœå‹™ `stdout` çš„ Log
éƒ¨åˆ†æœå‹™æ”¶çš„ Log æœ‰å…¶é‡è¦æ€§ï¼Œå»æœƒå› ç‚º `Datadog` ç¡¬é™åˆ¶å°Žè‡´ Log è¢«æˆªæ–·ï¼Œä¸”æš«æ™‚ç„¡æ³•è™•ç†
æ•…ï¼Œå”åŠ©è©•ä¼°ç¶­æŒ `stdout` æƒ…è·¨ä¸‹çš„ Log æ”¶é›†åŠå„²å­˜

### å…§å®¹
- é¸æ“‡
- Sidecar
- Daemonset-Agent

### æ¯”è¼ƒèˆ‡é¸æ“‡
|       |Sidecar         |Daemonset Agent     |
|-------|----------------|--------------------|
|è€¦åˆåº¦  |é«˜ï¼Œèˆ‡ Pod ç¶å®š   |ä½Žï¼Œèˆ‡æ‡‰ç”¨ç«¯å®Œå…¨è§£è€¦    |
|è³‡æºæ•ˆçŽ‡|æ¯å€‹ Pod æœ‰é¡å¤–é–‹éŠ·|æ¯å° Node åƒ…ä¸€å€‹ Agent|
|æ•…éšœè¡æ“Š|å°ï¼ŒæŒ‡å½±éŸ¿ Pod    |å¤§ï¼Œæ•´å€‹ Node         |

Sidecar è€ƒæ…®å…¬å¸ Tech-stack é¸æ“‡ç†Ÿæ‚‰çš„ `Fluent-bit`
Daemonset Agent å‰‡æ˜¯é¸æ“‡ Datadog ç”¨ Rust é–‹ç™¼çš„ `Vector`ï¼Œä¾†å¤šä¸€å€‹é¸æ“‡å¯ä»¥åƒè€ƒ

### Sidecar
> ### æ–¹æ¡ˆä¸€
> ![sidecar-classic](../assets/post/deepdive-stdout-log-to-opensearch/sidecar-classic.png)
> ### æœå‹™ log å¯«å…¥æŒ‡å®šè·¯å¾‘èˆ‡ fluent-bit å…±äº«( éœ€æ”¹ code )
> é€éŽ `Fluent-bit` Sidecar çš„æ–¹å¼æ”¶é›† log åœ¨é›†ä¸­é€åˆ° `Fluent Server` å¾Œï¼Œè½‰é€åˆ° `OpenSearch`
> ðŸ‘‰ å•é¡Œ
> éŽåŽ»é‡åˆ°éŽ `Fluent Server` æˆ– `OpenSearch` é‡åˆ° IOPS å£“åŠ›å°Žè‡´å †ç©
> æœƒè®“ `Fluent-bit` log æŒçºŒå †ç©è€Œé‡å•Ÿï¼Œæœ€å¾Œæœ‰å¯èƒ½å°Žè‡´ Pod é€£å¸¶è¢«åˆ¤å®šæœ‰å•é¡Œè€Œæ­»æŽ‰
> ðŸ‘‰ æ–¹æ¡ˆ
> æŽ’é™¤å †ç©å•é¡Œé»žå¾Œï¼Œè®“æœå‹™ Pod é‡å•Ÿå³å¯
> å¾ŒçºŒä¹Ÿæ³¨æ„åˆ° `fluent-server` æœ‰å°æ‡‰çš„æ©Ÿåˆ¶èˆ‡è¨­å®šï¼Œå¯ä»¥é¿å… OOM crash
> 
> ### æ–¹æ¡ˆäºŒ
> ![sidecar-stdout](../assets/post/deepdive-stdout-log-to-opensearch/sidecar-stdout.png)
> ### fluent-bit ç›´æŽ¥åˆ° Node æ’ˆå–æœå‹™ stdout çš„ log
> ðŸ‘‰ å•é¡Œ
> ç•¶é¡žä¼¼éœ€æ±‚çš„æœå‹™æ•¸é‡å¤šäº†ä¹‹å¾Œï¼Œæœƒæœ‰éŽå¤šé‡è¤‡æ€§çš„ process åšè‘—åŒæ¨£çš„äº‹æƒ…
> ðŸ‘‰ æ–¹æ¡ˆ
> é€éŽ `Daemonset Agent` çš„æ–¹å¼ï¼Œæ¸›å°‘ç›¸é—œè­°é¡Œ

#### å¯¦ä½œ

ðŸ‘‰ fluentBit Sidecar è¨­ç½®
> è«‹å¿½ç•¥ TAR çš„è¨­ç½®
> varlog-host-path æ˜¯å– `K8s-node-log`
> fluent-bit-db æ˜¯åœ¨ Pod å…§å»ºç«‹ä¸€å€‹ Pod ç´šåˆ¥ç”Ÿå‘½é€±æœŸçš„ DB ä¾†è¨˜éŒ„ Node-log è®€å–åˆ°å“ªï¼Œæ•…ä¸æœƒéš¨è‘— container restart è€Œæ¶ˆå¤±ï¼Œä½†æœƒéš¨è‘— Pod destroy & restart è€Œé‡ç½®
> 
> ![fluent-bit-classic](../assets/post/deepdive-stdout-log-to-opensearch/fluent-bit-classic.png)

ðŸ‘‰ fluent-server config
> ![fluent-server](../assets/post/deepdive-stdout-log-to-opensearch/fluent-server.png)

ðŸ‘‰ Log é‡è¤‡ç™¼é€
> ç”±æ–¼æ˜¯ Sidecarï¼Œæ‰€ä»¥å¦‚æžœæœå‹™è™•åœ¨åŒä¸€å€‹ Node ç¢ºå¯¦æœƒæœ‰é‡è¤‡ç™¼é€çš„å•é¡Œ
> é€™é‚Šæ–°å¢ž POD_NAME çš„ç’°å¢ƒè®Šæ•¸ï¼Œä¾†åš filter
> 
> ![podname](../assets/post/deepdive-stdout-log-to-opensearch/podname.png)
> 
> ![filter_podname](../assets/post/deepdive-stdout-log-to-opensearch/filter_podname.png)

ðŸ‘‰ é‡å°èƒŒå£“è™•ç† [å®˜æ–¹èªªæ˜Žé€£çµ](https://docs.fluentbit.io/manual/2.1/administration/backpressure)
> Fluent-bit æä¾›å…©ç¨® Buffer æ–¹å¼ä¾†æ‡‰å°èƒŒå£“
> ![backpressure](../assets/post/deepdive-stdout-log-to-opensearch/backpressure.png)
> å®˜æ–¹èªªæ˜Ž åªéœ€è¦ storage.type memory é…åˆ Mem_Buf_Limitï¼Œæ‡‰è©²å°±å¯ä»¥è§¸ç™¼ log æ”¶é›†çš„ pause & resume
> ![backpressure_mem](../assets/post/deepdive-stdout-log-to-opensearch/backpressure_mem.png)
> ![backpressure-mem-pause](../assets/post/deepdive-stdout-log-to-opensearch/backpressure-mem-pause.png)
> åªæ˜¯ç”±æ–¼ä¸Šè¿°çš„ Log é‚„æ˜¯å­˜åœ¨ Memory, æ•…æœƒæœ‰ OOM å°Žè‡´ Log éºå¤±çš„é¢¨éšª
> æ•…å¯ä»¥è®“ log å¯«å…¥ file åšé¡žæŒä¹…åŒ–ä¿å­˜ï¼Œå¾…é€å‡ºå¾Œæ¸…ç©º
> éœ€è¦æ³¨æ„çš„æ˜¯ `storage.type filesystem` æœƒè®“ `Mem_buf_Limit` å¤±æ•ˆï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ [storage.max_chunks_up](https://docs.fluentbit.io/manual/2.1/administration/buffering-and-storage#:~:text=Off-,storage.max_chunks_up,-If%20the%20input)
> ![backpressure-filesystem](../assets/post/deepdive-stdout-log-to-opensearch/backpressure-filesystem.png)
> ![backpressure-filesystem](../assets/post/deepdive-stdout-log-to-opensearch/backpressure-filesystem-pause.png)
> é€éŽ `storage.type filesystem` & `storage.max_chunks_up` ä¾†è™•ç†èƒŒå£“
> ![max_chunks](../assets/post/deepdive-stdout-log-to-opensearch/max_chunks.png)
> æœ€å¾Œçš„çµæžœ
> ![fluent-bit-stdout](../assets/post/deepdive-stdout-log-to-opensearch/fluent-bit-stdout.png)


### Daemonset - Agent
> é€éŽèˆ‡ Datadog-Agent ç›¸ä¼¼çš„æž¶æ§‹ï¼Œç›´æŽ¥åˆ° Node æŒ‡å®šä½ç½®æ’ˆ log å¾ŒæŠŠ log è½‰ç™¼æŒ‡å®š endpoint
> ![daemonset-agent](../assets/post/deepdive-stdout-log-to-opensearch/daemonset-agent.png)
> é€™å€‹æ–¹å¼è®“ log system èˆ‡æœå‹™è§£è€¦ï¼Œå¯ä»¥å€‹åˆ¥ç¨ç«‹çš„é‹è¡Œ
> åŽŸå‰‡ä¸Šæ˜¯æ¯”è¼ƒå¥½çš„æ–¹æ¡ˆï¼Œä½†ç”±æ–¼ Daemonset æ©Ÿåˆ¶æœƒåœ¨æ¯ä¸€é¡† Node é‹è¡Œä¸€å€‹ `Agent` æœå‹™
> æœƒæœ‰è³‡æºé‹ç”¨è€ƒé‡

#### å¯¦ä½œ

ðŸ‘‰ Vector Daemonset Agent è¨­ç½®
> - Vector
> - Fluent-bit
> 
> Fluent-bit æ˜¯ç†Ÿæ‚‰çš„å·¥å…·ï¼Œä¹Ÿç›¸ç•¶æˆç†Ÿ
> Vector å‰‡æ˜¯é™¤äº† logs ä»¥å¤–ï¼Œé‚„å¯ä»¥ metrics è’é›† ðŸ‘‰ [åƒè€ƒ](https://vector.dev/docs/reference/configuration/sources/prometheus_scrape/)
> ä½†åœ¨ data pipeline çš„éƒ¨åˆ†ï¼Œæœƒéœ€è¦åŽ»ç†Ÿæ‚‰ [VRL](https://vector.dev/docs/reference/configuration/transforms/remap/) çš„èªžæ³•
![vrl](../assets/post/deepdive-stdout-log-to-opensearch/vrl.png)
[VRL Playground](https://playground.vrl.dev/)
![vrl-playground](../assets/post/deepdive-stdout-log-to-opensearch/vrl-playground.png)
> 
> é€™é‚Šæ˜¯æ¸¬è©¦æ™‚ç”¨ Vector çš„ Daemonset-Agent mode ä¾†æ”¶é›† log ä¸¦é€åˆ° OpenSearch çš„è¨­ç½®
> ```yaml
> # æ›´å¤š customConfig åƒè€ƒ https://vector.dev/docs/reference/configuration/
> customConfig:
>   data_dir: /vector-data-dir
> 
>   # expose api for health-check
>   api:
>     enabled: true
>     address: 127.0.0.1:8686
>     playground: false
>   
>   # æ›´å¤š sources åƒè€ƒ https://vector.dev/docs/reference/configuration/sources/
>   sources:
>     kube_logs:
>       type: kubernetes_logs
>       auto_partial_merge: true
>       max_line_bytes: 52428800
>       max_merged_line_bytes: 104857600
>     es_metrics:
>       type: prometheus_scrape
>       auth:
>         strategy: "basic"
>         user: "elastic"
>         password: "2rxxxxxxxxxxxxxxxxxxxx0z"
>       endpoints:
>         - https://elasticsearch-es-coordinate.eck-stack:9200/_nodes/stats/jvm,os,indices
>       tls:
>         verify_certificate: false
>   
>   # æ›´å¤š transforms åƒè€ƒ https://vector.dev/docs/reference/configuration/transforms/
>   transforms:
>     flatten_pod_labels:
>       type: remap
>       inputs: [kube_logs]
>       source: |
>         if exists(.kubernetes.pod_labels) {
>           del(.kubernetes.pod_labels)
>         }
>     es_metrics_op:
>       type: remap
>       inputs:
>         - es_metrics
>       source: |
>         .tags.product = "bbin"
>         .tags.env = "qa"
>         .tags.dept = "pdpi"
>         .tags.pd_group = "pi"
>         .tags.resource = "vector"
>
>   # Vector ä¸­ OpenSearch çš„ sinks èˆ‡ elasticsearch æ˜¯ä¸€æ¨£çš„
>   # æ›´å¤š sinks åƒè€ƒ https://vector.dev/docs/reference/configuration/sinks/
>   sinks:
>     opensearch:
>       api_version: v8
>       type: elasticsearch
>       inputs:
>         - flatten_pod_labels
>       endpoints:
>         - "http://opensearch-ingest.opensearch.svc.cluster.local:9200"
>       tls:
>         verify_certificate: false
>     
>     # datadog_metrics:
>     #   type: datadog_metrics
>     #   inputs:
>     #     - es_metrics_op
>     #   default_api_key: "69xxxxxxxxxxxxxxxxxxxxxxxxxxxxd6"
>     #   tls:
>     #     verify_certificate: false
> 
>     console:
>       type: console
>       inputs:
>         - es_metrics
>       encoding:
>         codec: "text"
> 
> 
> service:
>   enabled: true
>   ports:
>     - name: prom-exporter
>       port: 9090
>       protocol: TCP
>       targetPort: 9090
> ```

### OpenSearch Dashboard è¨­ç½®

> Discover è¦å¯ä»¥çœ‹å°æ‡‰ index çš„ log
> æœƒéœ€è¦å…ˆè¨­ç½®ä¾†æº index
> ![index](../assets/post/deepdive-stdout-log-to-opensearch/index.png)
> `Stack Management` >> `Index patterns`
> ![index-patterns](../assets/post/deepdive-stdout-log-to-opensearch/index-patterns.png)
> å®Œæˆè¨­ç½®å¾Œå°±å¯ä»¥çœ‹åˆ° [å‚³é€é–€](https://opensearch.out.in.qa.rdapp.vip/app/discover#/?_g=(filters:!(),query:(language:kuery,query:''),refreshInterval:(pause:!f,value:900000),time:(from:now-3d,to:now))&_a=(columns:!(_source),filters:!(),index:egp,interval:auto,query:(language:kuery,query:''),sort:!()))
> ![discovery](../assets/post/deepdive-stdout-log-to-opensearch/discovery.png)
> 